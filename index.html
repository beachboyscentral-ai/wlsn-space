<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>WLSN | Western Light and Sound Network</title>

<!-- Favicons (keep these files in your site root) -->
<link rel="icon" type="image/png" href="favicon.png">
<link rel="icon" type="image/x-icon" href="favicon.ico">
<link rel="apple-touch-icon" href="apple-touch-icon.png">

<!-- Optional (later): RSS feed for podcatchers -->
<!-- <link rel="alternate" type="application/rss+xml" title="WLSN Broadcast Archive" href="feed.xml"> -->

<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--crt-green:#28d428;
--crt-dim:#0d5a0d;
--crt-bg:#0b110b;
--crt-glow:rgba(40,212,40,0.55);
--mono:'Courier New',monospace;
}

body{
font-family:var(--mono);
background:var(--crt-bg);
color:var(--crt-green);
line-height:1.6;
font-size:13px;
text-shadow:0 0 3px var(--crt-glow);
padding-bottom:80px;
}

body::before{
content:'';
position:fixed;top:0;left:0;width:100%;height:100%;
background:repeating-linear-gradient(
0deg,
rgba(0,0,0,0.12) 0px,
rgba(0,0,0,0.12) 1px,
transparent 1px,
transparent 2px
);
pointer-events:none;
z-index:9999;
opacity:0.65;
}

.container{max-width:1000px;margin:0 auto;padding:40px 20px}

header{
border-top:2px solid var(--crt-green);
border-bottom:2px solid var(--crt-green);
padding:20px 0;
margin-bottom:28px;
}

.logo{
font-size:36px;
font-weight:700;
letter-spacing:12px;
margin-bottom:10px;
text-shadow:0 0 8px var(--crt-glow);
line-height:1.1;
}

/* Cursor sizing and alignment */
.logo .cursor{
font-size:22px;
line-height:1;
display:inline-block;
vertical-align:baseline;
margin-left:8px;
animation:blink 1.6s infinite;
position:relative;
top:-5px;
opacity:0.95;
}

.tagline{
font-size:11px;
letter-spacing:2px;
color:#4a9a4a;
text-transform:uppercase;
opacity:0.75;
}

/* Make "Signal Archive" slightly blurrier */
.tagline-sub{
margin-top:2px;
opacity:0.62;
filter: blur(1.15px);
}

/* Session indicator is its own panel */
.session-panel{
margin-top:14px;
border:1px solid var(--crt-dim);
background:rgba(0,0,0,0.28);
padding:10px 12px;
font-size:10px;
letter-spacing:2px;
color:var(--crt-dim);
opacity:0.95;
filter: blur(0.25px);
}
.session-panel b{color:var(--crt-green);font-weight:400;filter:none}

nav{
margin-top:18px;
padding-top:18px;
border-top:1px solid var(--crt-dim);
display:flex;
gap:6px;
align-items:center;
flex-wrap:wrap;
}

/* Sitewide button rule:
- default: black fill + green outline
- hover: green fill + glow
- active (current page): subtle green tint + glow, still readable at a glance
*/
.btn,
.btn:visited,
nav a,
nav a:visited{
display:inline-block;
background:transparent;
color:var(--crt-green);
padding:12px 18px;
text-decoration:none;
font-size:10px;
text-transform:uppercase;
letter-spacing:2px;
font-weight:700;
border:2px solid var(--crt-green);
cursor:pointer;
transition:background .08s, color .08s, box-shadow .08s, opacity .08s;
}

.btn:hover,
nav a:hover{
background:var(--crt-green);
color:var(--crt-bg);
box-shadow:0 0 14px rgba(0,255,102,0.25);
}

nav a.active{
background:rgba(40,212,40,0.14);
box-shadow:0 0 14px rgba(0,255,102,0.18);
}

/* keep nav alignment even */
nav a{
text-align:center;
min-width:200px;
}

.intro{
border:1px solid var(--crt-dim);
border-left:4px solid var(--crt-green);
padding:26px;
margin-bottom:24px;
background:rgba(0,0,0,0.18);
}
.intro h1{
font-size:14px;
margin-bottom:14px;
text-transform:uppercase;
letter-spacing:2px;
font-weight:700;
border-bottom:1px solid var(--crt-green);
padding-bottom:8px;
}
.intro p{margin-bottom:12px;line-height:1.8;opacity:0.86}

.back-link{
display:inline-block;
margin-bottom:18px;
color:var(--crt-green);
text-decoration:none;
font-size:11px;
text-transform:uppercase;
letter-spacing:1px;
opacity:0.7;
}
.back-link:hover{opacity:1}
.back-link::before{content:'← '}

.grid{display:block;margin-top:16px;border:1px solid var(--crt-dim)}
.card{
border-bottom:1px solid var(--crt-dim);
padding:20px 18px;
cursor:pointer;
background:rgba(0,0,0,0.10);
position:relative;
}
.card:hover{background:rgba(51,255,51,0.05)}
.card-id{font-size:10px;color:var(--crt-green);margin-bottom:8px;letter-spacing:1.5px;font-weight:700;opacity:0.7}
.card-title{font-size:16px;font-weight:700;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px}
.card-date{font-size:10px;color:var(--crt-dim);margin-bottom:10px;opacity:0.7}
.card-desc{font-size:13px;line-height:1.6;opacity:0.82}
.card-status{
position:absolute;
top:20px;
right:18px;
display:flex;
gap:6px;
}

/* Feature block on archive landing */
.feature{
border:1px solid var(--crt-dim);
border-left:4px solid var(--crt-green);
padding:18px;
margin:18px 0 22px;
background:rgba(0,0,0,0.18);
}
.feature .feature-title{
font-size:11px;
text-transform:uppercase;
letter-spacing:2px;
opacity:0.85;
margin-bottom:10px;
border-bottom:1px solid var(--crt-green);
padding-bottom:8px;
font-weight:700;
}
.feature p{opacity:0.82}

/* Badges (not buttons) */
.badge{
display:inline-block;
padding:6px 10px;
border:1px dashed var(--crt-dim);
color:var(--crt-green);
background:rgba(0,0,0,0.22);
letter-spacing:2px;
font-size:10px;
cursor:default;
user-select:none;
opacity:0.95;
}
.badge.received{border-color:var(--crt-green)}
.badge.archived{border-color:var(--crt-dim);filter:blur(0.15px)}
.badge.audio-ready{border-color:var(--crt-green);border-style:solid}
.badge.no-audio{border-color:var(--crt-dim);opacity:0.5}
.badge:hover{background:rgba(0,0,0,0.22);box-shadow:none}

.transmission-header{
border:2px solid var(--crt-green);
padding:26px;
margin-bottom:22px;
background:rgba(0,0,0,0.14);
}
.transmission-id{font-size:10px;margin-bottom:10px;letter-spacing:2px;font-weight:700;opacity:0.7}
.transmission-title{font-size:22px;font-weight:700;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px}
.transmission-date{font-size:10px;color:var(--crt-dim);margin-bottom:14px;opacity:0.7}

.section{
border:1px solid var(--crt-dim);
border-left:3px solid var(--crt-dim);
padding:18px;
margin-bottom:18px;
background:rgba(0,0,0,0.14);
}
.section-title{
font-size:11px;text-transform:uppercase;letter-spacing:2px;margin-bottom:14px;
border-bottom:1px solid var(--crt-green);padding-bottom:8px;font-weight:700
}

.breakdown-table{
width:100%;
border-collapse:collapse;
font-size:11px;
border:1px solid var(--crt-dim);
margin:14px 0 18px;
}
.breakdown-table thead{background:rgba(51,255,51,0.08)}
.breakdown-table th{
padding:10px 12px;text-align:left;font-weight:700;letter-spacing:1.5px;font-size:10px;
border-right:1px solid var(--crt-dim);border-bottom:1px solid var(--crt-green)
}
.breakdown-table td{
padding:12px 12px;border-bottom:1px solid var(--crt-dim);border-right:1px solid var(--crt-dim);
overflow-wrap:anywhere;word-break:break-word;
}
.breakdown-table tbody tr:hover{background:rgba(51,255,51,0.05)}

.element-link{color:var(--crt-green);text-decoration:underline;cursor:pointer;font-weight:700}
.element-link:hover{color:#fff;text-shadow:0 0 10px var(--crt-glow)}
.type-badge{display:inline-block;padding:2px 6px;font-size:9px;letter-spacing:1px;font-weight:700;text-transform:uppercase;border:1px solid var(--crt-dim);opacity:0.9}

.confidence-high{color:var(--crt-green);font-weight:700}
.confidence-medium{color:var(--crt-dim);font-weight:700}
.confidence-low{color:#ff3333;font-weight:700}

/* Filters on transmission pages */
.transmission-filters{
display:flex;gap:12px;align-items:center;flex-wrap:wrap;
margin:16px 0;padding:12px;border:1px solid var(--crt-dim);background:rgba(0,0,0,0.22);
}
.transmission-filters input,
.transmission-filters select{
flex:1;min-width:220px;
background:rgba(0,0,0,0.35);
border:1px solid var(--crt-green);
color:var(--crt-green);
padding:10px 12px;
font-family:var(--mono);
font-size:12px;
outline:none;
}
.transmission-filters select{flex:0.65}

/* Audio player - page version (hidden when persistent player is active) */
.audio-player{border:1px solid var(--crt-dim);padding:16px;margin:16px 0;background:rgba(0,0,0,0.26)}
.audio-controls{display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
.play-btn{
width:40px;height:40px;border:2px solid var(--crt-green);
background:transparent;color:var(--crt-green);cursor:pointer;
font-family:var(--mono);font-size:16px;transition:all .08s
}
.play-btn:hover{background:var(--crt-green);color:var(--crt-bg)}
.play-btn:disabled{opacity:0.35;cursor:not-allowed}
.time-display{font-family:var(--mono);font-size:11px;color:var(--crt-green);letter-spacing:1px;min-width:110px}
.timeline{flex:1;min-width:180px;height:4px;background:var(--crt-dim);position:relative;cursor:pointer}
.timeline-progress{height:100%;background:var(--crt-green);width:0%}
.timeline-handle{
position:absolute;top:-4px;width:12px;height:12px;background:var(--crt-green);
border:1px solid var(--crt-green);transform:translateX(-50%);cursor:pointer;
box-shadow:0 0 5px var(--crt-glow)
}
.volume-control{display:flex;align-items:center;gap:10px}
.volume-icon{font-family:var(--mono);font-size:11px;color:var(--crt-green);letter-spacing:1px;opacity:0.9}
.volume-slider{width:90px;height:4px;background:var(--crt-dim);position:relative;cursor:pointer}
.volume-level{height:100%;background:var(--crt-green);width:100%}
.track-info{font-family:var(--mono);font-size:10px;color:var(--crt-dim);margin-top:8px;opacity:0.75}

/* INFO page layout */
.info-shell{border:1px solid var(--crt-dim);padding:16px;background:rgba(0,0,0,0.18)}

.info-grid{
display:grid;
grid-template-columns: 1.35fr 0.95fr;
gap:16px;
align-items:start;
}

.chat-container{
border:1px solid var(--crt-dim);
height:520px;
overflow:hidden;
background:rgba(0,0,0,0.28);
position:relative;
}
.chat-log{
font-size:11px;
line-height:2.2;
position:absolute;
width:calc(100% - 30px);
left:15px;
top:0;
}
.chat-msg{margin-bottom:15px}
.chat-user{color:var(--crt-green);font-weight:700}
.chat-bot{color:var(--crt-dim);font-weight:700}
.chat-location{color:var(--crt-dim);font-size:10px;margin-left:6px}
.chat-timestamp{color:var(--crt-dim);font-size:10px;margin-right:8px}

.chat-input-area{
margin-top:12px;
border:1px solid var(--crt-dim);
padding:14px;
background:rgba(0,0,0,0.22);
display:flex;
gap:12px;
align-items:center;
}
.chat-input-area input{
flex:1;
font-family:var(--mono);
font-size:11px;
padding:10px 12px;
border:1px solid var(--crt-green);
background:rgba(0,0,0,0.35);
color:var(--crt-green);
outline:none;
}
.chat-input-area button{min-width:110px}

/* Newsletter message */
.message{
margin-top:10px;
padding:10px;
border:1px solid var(--crt-green);
font-size:11px;
display:none;
}
.message.success{color:var(--crt-green)}
.message.error{color:#ff3333;border-color:#ff3333}

/* Slideshow stage */
.slideshow-stage{
position:relative;
width:100%;
aspect-ratio: 16 / 9;
border:1px solid var(--crt-dim);
overflow:hidden;
background:#000;
}

/* Oscilloscope */
.oscilloscope-player{
border:1px solid var(--crt-dim);
padding:16px;
margin:16px 0;
background:rgba(0,0,0,0.26);
}
.player-layout{
display:flex;
gap:16px;
align-items:flex-start;
}
.player-main{
flex:1;
min-width:0;
}
.player-scope{
flex-shrink:0;
}
.scope-container{
position:relative;
width:140px;
}
.scope-display{
position:relative;
width:140px;
height:140px;
background:#000;
border:2px solid var(--crt-dim);
border-radius:50%;
overflow:hidden;
box-shadow:
inset 0 0 20px rgba(40,212,40,0.1),
0 0 10px rgba(0,0,0,0.5);
}
.scope-canvas{
width:100%;
height:100%;
display:block;
filter:blur(0.4px);
}
.scope-grid{
position:absolute;
inset:0;
pointer-events:none;
opacity:0.12;
}
.scope-grid::before,
.scope-grid::after{
content:'';
position:absolute;
background:var(--crt-green);
}
.scope-grid::before{
left:50%;
top:10%;
bottom:10%;
width:1px;
transform:translateX(-50%);
}
.scope-grid::after{
top:50%;
left:10%;
right:10%;
height:1px;
transform:translateY(-50%);
}
.scope-label{
margin-top:6px;
text-align:center;
font-size:8px;
letter-spacing:1.5px;
text-transform:uppercase;
color:var(--crt-dim);
opacity:0.7;
}

/* Mobile: stack oscilloscope below player */
@media (max-width: 640px){
.player-layout{
flex-direction:column;
}
.scope-container{
margin:0 auto;
}
}

.slideshow-stage img{
position:absolute;inset:0;
width:100%;height:100%;
object-fit:cover;
opacity:0;
transition:opacity 1.2s ease;
filter: grayscale(1) contrast(1.05) brightness(0.9) blur(0.2px);
transform:scale(1.01);
}
.slideshow-stage img.active{opacity:1}
.slideshow-stage::after{
content:'';
position:absolute;inset:0;
background:repeating-linear-gradient(
0deg,
rgba(0,0,0,0.20) 0px,
rgba(0,0,0,0.20) 1px,
transparent 1px,
transparent 2px
);
mix-blend-mode:overlay;
opacity:0.55;
pointer-events:none;
}
.slideshow-caption{
position:absolute;
left:10px;right:10px;bottom:10px;
padding:8px 10px;
border:1px solid var(--crt-dim);
background:rgba(0,0,0,0.55);
color:var(--crt-green);
font-size:10px;
letter-spacing:1px;
opacity:0.65;
filter: blur(0.15px);
}

footer{
margin-top:54px;
padding-top:18px;
border-top:1px solid var(--crt-dim);
font-size:9px;
color:var(--crt-dim);
text-align:center;
opacity:0.62;
line-height:1.8;
}

@keyframes blink{0%,49%{opacity:1}50%,100%{opacity:0}}

/* Persistent bottom player */
.persistent-player{
position:fixed;
left:0;right:0;bottom:0;
border-top:2px solid var(--crt-green);
background:rgba(11,17,11,0.98);
backdrop-filter: blur(8px);
padding:12px 16px;
z-index:9998;
display:none;
box-shadow:0 -4px 20px rgba(0,255,102,0.15);
}
.persistent-player.active{display:block}
.persistent-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;max-width:1000px;margin:0 auto}
.persistent-title{
font-size:10px;
letter-spacing:2px;
color:var(--crt-dim);
opacity:0.9;
min-width:200px;
}
.persistent-title b{color:var(--crt-green);font-weight:700}
.persistent-controls{
flex:1;
display:flex;
gap:12px;
align-items:center;
min-width:300px;
}
.persistent-play{
width:32px;
height:32px;
border:2px solid var(--crt-green);
background:transparent;
color:var(--crt-green);
cursor:pointer;
font-family:var(--mono);
font-size:14px;
transition:all .08s;
display:flex;
align-items:center;
justify-content:center;
}
.persistent-play:hover{background:var(--crt-green);color:var(--crt-bg)}
.persistent-timeline{
flex:1;
height:4px;
background:var(--crt-dim);
position:relative;
cursor:pointer;
min-width:150px;
}
.persistent-timeline-progress{height:100%;background:var(--crt-green);width:0%}
.persistent-time{
font-size:10px;
letter-spacing:1px;
color:var(--crt-dim);
min-width:90px;
opacity:0.9;
}
.persistent-actions{margin-left:auto;display:flex;gap:8px;align-items:center}
.small-btn{
padding:8px 12px;
font-size:9px;
letter-spacing:2px;
border:1px solid var(--crt-green);
background:transparent;
color:var(--crt-green);
cursor:pointer;
transition:all .08s;
}
.small-btn:hover{background:var(--crt-green);color:var(--crt-bg)}

/* Mobile: no sideways scroll, tables become blocks */
@media (max-width: 900px){
nav a{min-width:auto;flex:1}
.info-shell{border:1px solid var(--crt-dim);padding:16px;background:rgba(0,0,0,0.18)}

.info-grid{grid-template-columns:1fr}
.persistent-row{flex-direction:column;align-items:stretch;gap:10px}
.persistent-title{min-width:auto}
.persistent-controls{min-width:auto}
.persistent-actions{margin-left:0;justify-content:flex-end}
}

@media (max-width: 640px){
.container{padding:20px 12px}
.logo{font-size:24px}
.logo .cursor{font-size:14px;top:-3px}

nav{gap:8px}
nav a{padding:12px 10px;font-size:9px}

.breakdown-table thead{display:none}
.breakdown-table, .breakdown-table tbody, .breakdown-table tr{display:block;width:100%}
.breakdown-table tr{
border:1px solid var(--crt-dim);
margin:12px 0;
padding:10px;
background:rgba(0,0,0,0.20);
}
.breakdown-table td{
display:flex;
gap:6px;
width:100%;
padding:6px 0;
border:0;
align-items:flex-start;
}
.breakdown-table td:nth-child(1)::before{content:"TIME"; min-width:70px; color:var(--crt-dim); letter-spacing:1px;}
.breakdown-table td:nth-child(2)::before{content:"TYPE"; min-width:70px; color:var(--crt-dim); letter-spacing:1px;}
.breakdown-table td:nth-child(3)::before{content:"TITLE"; min-width:70px; color:var(--crt-dim); letter-spacing:1px;}
.breakdown-table td:nth-child(4)::before{content:"CREDIT"; min-width:70px; color:var(--crt-dim); letter-spacing:1px;}
.breakdown-table td:nth-child(5)::before{content:"CONF"; min-width:70px; color:var(--crt-dim); letter-spacing:1px;}
}

/* Session overlay (login) */
#session-overlay{
position:fixed;inset:0;
background:rgba(0,0,0,0.90);
display:none;
align-items:center;
justify-content:center;
z-index:10000;
padding:20px;
}
#session-overlay.active{display:flex}

.session-window{
width:min(460px,100%);
border:1px solid var(--crt-dim);
background:rgba(0,0,0,0.55);
box-shadow:0 0 40px rgba(0,255,80,0.12);
padding:22px;
position:relative;
}

.session-window::before{
content:'';
position:absolute;inset:0;
background:repeating-linear-gradient(
0deg,
rgba(0,0,0,0.14) 0px,
rgba(0,0,0,0.14) 1px,
transparent 1px,
transparent 2px
);
opacity:0.65;
pointer-events:none;
}

.session-title{
position:relative;
text-align:center;
font-size:13px;
letter-spacing:3px;
text-transform:uppercase;
font-weight:700;
margin-bottom:16px;
opacity:0.98;
filter: blur(0.35px);
}

.session-row{
position:relative;
display:flex;
flex-direction:column;
gap:6px;
align-items:center;
}

.session-row label{
font-size:10px;
color:var(--crt-dim);
letter-spacing:2px;
text-transform:uppercase;
filter: blur(0.25px);
}

.session-input{
width:min(320px,100%);
border:1px solid var(--crt-green);
background:rgba(0,0,0,0.40);
color:var(--crt-green);
padding:12px 12px;
font-family:var(--mono);
font-size:12px;
outline:none;
text-transform:uppercase;
letter-spacing:2px;
text-align:center;
}

.session-actions{
position:relative;
display:flex;
justify-content:center;
margin-top:16px;
}

.session-actions .btn{
width:min(320px,100%);
text-align:center;
}

/* Element detail modal */
/* Element modal - redesigned with image, player, oscilloscope */
.modal-backdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10001;
  padding:20px;
  overflow-y:auto;
}
.modal-backdrop.active{display:flex;}

.modal{
  width:min(920px,96vw);
  max-height:90vh;
  overflow:auto;
  border:2px solid var(--crt-green);
  background:rgba(0,0,0,0.95);
  box-shadow:0 0 30px rgba(0,255,102,0.2);
  padding:24px;
  position:relative;
}

.modal::before{
  content:'';
  position:absolute;
  inset:0;
  background:repeating-linear-gradient(
    0deg,
    rgba(0,0,0,0.1) 0px,
    rgba(0,0,0,0.1) 1px,
    transparent 1px,
    transparent 2px
  );
  opacity:0.4;
  pointer-events:none;
  z-index:0;
}

.modal-header{
  display:flex;
  align-items:flex-start;
  gap:12px;
  margin-bottom:20px;
  position:relative;
  z-index:1;
  border-bottom:2px solid var(--crt-green);
  padding-bottom:14px;
}

.modal-title{
  font-size:14px;
  letter-spacing:2px;
  text-transform:uppercase;
  font-weight:700;
  flex:1;
}

.modal-close,
.element-close{
  margin-left:auto;
  border:2px solid var(--crt-green);
  background:transparent;
  color:var(--crt-green);
  cursor:pointer;
  padding:10px 14px;
  font-size:9px;
  letter-spacing:2px;
  text-transform:uppercase;
  transition:all .08s;
}
.modal-close:hover,
.element-close:hover{
  background:var(--crt-green);
  color:var(--crt-bg);
}

.modal-layout{
  display:grid;
  grid-template-columns:380px 1fr;
  gap:24px;
  position:relative;
  z-index:1;
}

.modal-media{
  display:flex;
  flex-direction:column;
  gap:16px;
}

.modal-image{
  width:100%;
  aspect-ratio:4/3;
  border:1px solid var(--crt-dim);
  background:rgba(0,0,0,0.5);
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
}

.modal-image img{
  width:100%;
  height:100%;
  object-fit:cover;
  filter:grayscale(0.2) contrast(1.08);
}

.modal-image::after{
  content:'NO IMAGE';
  position:absolute;
  font-size:10px;
  letter-spacing:2px;
  color:var(--crt-dim);
  opacity:0.4;
  pointer-events:none;
}

.modal-image:has(img[style*="display: block"])::after{
  display:none;
}

.modal-player{
  border:1px solid var(--crt-dim);
  background:rgba(0,0,0,0.4);
  padding:14px;
}

.player-row{
  display:flex;
  gap:14px;
  align-items:center;
}

.player-main{
  flex:1;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.player-btn{
  width:100%;
  height:36px;
  border:2px solid var(--crt-green);
  background:transparent;
  color:var(--crt-green);
  cursor:pointer;
  font-family:var(--mono);
  font-size:11px;
  letter-spacing:2px;
  transition:all .08s;
}
.player-btn:hover{
  background:var(--crt-green);
  color:var(--crt-bg);
}

.player-timeline{
  width:100%;
  height:4px;
  background:var(--crt-dim);
  position:relative;
  cursor:pointer;
}

.player-progress{
  height:100%;
  background:var(--crt-green);
  width:0%;
  transition:width 0.1s linear;
}

.player-time{
  font-size:10px;
  letter-spacing:1px;
  color:var(--crt-dim);
  text-align:center;
  opacity:0.85;
}

.player-scope{
  flex-shrink:0;
}

.scope-circle{
  position:relative;
  width:70px;
  height:70px;
  background:#000;
  border:2px solid var(--crt-dim);
  border-radius:50%;
  overflow:hidden;
  box-shadow:inset 0 0 12px rgba(40,212,40,0.08);
}

#element-modal-scope{
  width:100%;
  height:100%;
  display:block;
  filter:blur(0.3px);
}

.scope-grid{
  position:absolute;
  inset:0;
  pointer-events:none;
  opacity:0.12;
}

.scope-grid::before,
.scope-grid::after{
  content:'';
  position:absolute;
  background:var(--crt-green);
}

.scope-grid::before{
  left:50%;
  top:10%;
  bottom:10%;
  width:1px;
  transform:translateX(-50%);
}

.scope-grid::after{
  top:50%;
  left:10%;
  right:10%;
  height:1px;
  transform:translateY(-50%);
}

.modal-info{
  display:flex;
  flex-direction:column;
}

.modal-meta{
  display:grid;
  grid-template-columns:120px 1fr;
  gap:10px 14px;
  font-size:11px;
  margin-bottom:4px;
  position:relative;
}

.modal-meta .k{
  color:var(--crt-dim);
  letter-spacing:1px;
  font-size:10px;
  text-transform:uppercase;
  opacity:0.85;
}

.modal-meta .v{
  color:var(--crt-green);
  opacity:0.9;
}

.modal-block{
  margin-top:16px;
  border-top:1px solid var(--crt-dim);
  padding-top:12px;
}

.modal-block .k{
  display:block;
  color:var(--crt-dim);
  letter-spacing:1px;
  margin-bottom:8px;
  font-size:10px;
  text-transform:uppercase;
  opacity:0.85;
}

.modal-block .v{
  white-space:pre-wrap;
  color:var(--crt-green);
  font-size:11px;
  line-height:1.6;
  opacity:0.9;
}

@media (max-width: 768px){
  .modal-layout{
    grid-template-columns:1fr;
  }
  
  .player-row{
    flex-direction:column-reverse;
    align-items:stretch;
  }
  
  .scope-circle{
    margin:0 auto;
  }
}

</style>
</head>

<body>

<!-- Session gate (centered, no explainer copy, no session id shown, no anonymous option) -->
<div id="session-overlay" aria-hidden="true">
<div class="session-window">
<div class="session-title">WLSN SIGNAL ARCHIVE TERMINAL</div>

<div class="session-row">
<label for="alias-input"></label>
<input id="alias-input" class="session-input" maxlength="18" autocomplete="off" spellcheck="false" placeholder="YOUR NAME">
</div>

<div class="session-actions">
<button id="enter-btn" class="btn" type="button">ENTER</button>
</div>
</div>
</div>

<!-- Element detail modal -->
<!-- Element modal (redesigned with image, player, oscilloscope) -->
<div class="modal-backdrop" id="element-modal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <!-- Header row -->
    <div class="modal-header">
      <div class="modal-title" id="element-modal-title">ARTIFACT</div>
      <button class="modal-close" id="element-close" type="button">CLOSE</button>
    </div>

    <!-- Two-column layout for media + metadata -->
    <div class="modal-layout">
      <!-- Left column: Image and Player -->
      <div class="modal-media">
        <!-- Image -->
        <div class="modal-image" id="element-modal-image">
          <img id="element-modal-image-src" alt="" style="display:none;">
        </div>

        <!-- Mini Player with Oscilloscope -->
        <div class="modal-player">
          <div class="player-row">
            <div class="player-main">
              <button class="player-btn" id="element-modal-play" type="button">▶ PLAY SOURCE</button>
              <div class="player-timeline" id="element-modal-timeline">
                <div class="player-progress" id="element-modal-progress"></div>
              </div>
              <div class="player-time" id="element-modal-time">00:00 / 00:00</div>
            </div>
            <div class="player-scope">
              <div class="scope-circle">
                <canvas id="element-modal-scope" width="70" height="70"></canvas>
                <div class="scope-grid"></div>
              </div>
            </div>
          </div>
          <audio id="element-modal-audio" preload="metadata"></audio>
        </div>
      </div>

      <!-- Right column: Metadata -->
      <div class="modal-info">
        <div class="modal-meta" id="element-modal-meta">
          <!-- Populated by JS -->
        </div>

        <div class="modal-block">
          <span class="k">Source</span>
          <div class="v" id="element-modal-source"></div>
        </div>

        <div class="modal-block">
          <span class="k">Notes</span>
          <div class="v" id="element-modal-notes"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Persistent audio player (bottom bar) -->
<div id="persistent-player" class="persistent-player" aria-hidden="true">
<div class="persistent-row">
<div class="persistent-title">
NOW PLAYING: <b id="pp-title">None</b>
</div>
<div class="persistent-controls">
<button class="persistent-play" id="pp-play" type="button">▶</button>
<div class="persistent-timeline" id="pp-timeline">
<div class="persistent-timeline-progress" id="pp-progress"></div>
</div>
<div class="persistent-time" id="pp-time">00:00 / 00:00</div>
</div>
<div class="persistent-actions">
<button class="small-btn" id="pp-hide" type="button">CLOSE</button>
</div>
</div>
<audio id="pp-audio" preload="metadata"></audio>
</div>

<div class="container">
<header>
<div class="logo">WLSN<span class="cursor">█</span></div>
<div class="tagline">Western Light and Sound Network</div>
<div class="tagline tagline-sub">Signal Archive</div>

<div id="session-indicator" class="session-panel"></div>

<nav>
<a href="#transmissions" id="nav-transmissions">Transmission Archive</a>
<a href="#info" id="nav-info">Info</a>
</nav>
</header>

<main id="app"></main>

<footer>
WLSN ARCHIVE SYSTEM | EST. 1967 | DECLASSIFIED 2025<br>
Produced by Brain Crampsmen for WLSN under the ONE Signal distribution mark.
</footer>
</div>

<script>
const D = {
transmissions: [
{
id:"001",
title:"Initial Signal Test",
date:"1967-08-12",
dateFormatted:"12 AUG 1967",
audioUrl:"audio/WLSN - Color Radio from Space - TRANSMISSION 001 - -Initial Signal Test - RECORDED- 12 AUG 1967_2_01.mp3",
description:"First recorded transmission. Test pattern followed by musical fragments.",
notes:"Recovered from magnetic tape, reel 001-A. Signal degradation minimal.",
elements:["e001","e002","e036","e003","e004"]
},
{
id:"002",
title:"Evening Broadcast",
date:"1967-09-03",
dateFormatted:"03 SEP 1967",
audioUrl:"",
description:"Regular programming. Mix of commercial recordings and field recordings.",
notes:"Source uncertain. Possible aircheck from listening post.",
elements:["e005","e037","e006","e007"]
},
{
id:"003",
title:"Late Night Transmission",
date:"1968-03-15",
dateFormatted:"15 MAR 1968",
audioUrl:"",
description:"Cut broadcast. Multiple sources spliced together.",
notes:"Tape quality excellent. Signal bleed appears intermittently.",
elements:["e035","e008","e009","e010","e011","e012","e038","e013","e014","e015","e016","e017","e018","e019","e020","e021","e022","e023","e024","e025","e026","e027","e039","e028","e029","e030","e031","e032","e033","e034"]
}
],
elements: [
{id:"e001",transmission_id:"001",start_time:"00:00",end_time:"00:45",type:"jingle",title:"WLSN Station Identification",primary_credit:"Unknown Announcer",source:"WLSN Internal Recording",year:"1967",notes:"Male voice. Broadcast training evident.",confidence:"high"},
{id:"e002",transmission_id:"001",start_time:"00:45",end_time:"04:12",type:"song",title:"Blue in Green",primary_credit:"Miles Davis",source:"Kind of Blue (Columbia, 1959)",year:"1959",notes:"Partial capture. Fades early.",confidence:"high"},
{id:"e003",transmission_id:"001",start_time:"04:12",end_time:"04:30",type:"unknown",title:"Unidentified Voice Fragment",primary_credit:"Unknown",source:"Unknown",year:null,notes:"Female voice. Possible adjacent-channel crosstalk.",confidence:"low"},
{id:"e004",transmission_id:"001",start_time:"04:30",end_time:"05:00",type:"technical",title:"1kHz Reference Tone",primary_credit:"WLSN Technical",source:"Calibration Reference",year:"1967",notes:"Frequency reference signal.",confidence:"high"},
{id:"e036",transmission_id:"001",start_time:"02:18",end_time:"02:22",type:"unknown",title:"Carrier Wave Interference",primary_credit:"Unknown",source:"Unknown",year:null,notes:"Brief heterodyne whistle. Frequency bleed.",confidence:"low"},

{id:"e005",transmission_id:"002",start_time:"00:00",end_time:"00:15",type:"technical",title:"Time Signal",primary_credit:"WLSN Technical",source:"Synchronization",year:"1967",notes:"Six pip sequence.",confidence:"high"},
{id:"e006",transmission_id:"002",start_time:"00:15",end_time:"07:45",type:"song",title:"A Love Supreme, Pt 1",primary_credit:"John Coltrane",source:"A Love Supreme (Impulse!, 1965)",year:"1965",notes:"Complete Part 1. Excellent fidelity.",confidence:"high"},
{id:"e007",transmission_id:"002",start_time:"07:45",end_time:"08:10",type:"commercial",title:"Soft Drink Advertisement",primary_credit:"Unknown",source:"Radio Campaign",year:"1967",notes:"Regional variant possible.",confidence:"medium"},
{id:"e037",transmission_id:"002",start_time:"04:22",end_time:"04:31",type:"unknown",title:"Spanish Language Fragment",primary_credit:"Unknown",source:"Unknown",year:null,notes:"Likely border-station bleed.",confidence:"low"},

{id:"e008",transmission_id:"003",start_time:"00:00",end_time:"00:15",type:"jingle",title:"Weather Tag",primary_credit:"Los Angeles Station",source:"Broadcast Capture",year:"1968",notes:"Station tag fragment.",confidence:"high"},
{id:"e009",transmission_id:"003",start_time:"00:15",end_time:"00:45",type:"commercial",title:"Cereal Spot",primary_credit:"Unknown",source:"Broadcast Capture",year:"1968",notes:"Cut version possible.",confidence:"high"},
{id:"e010",transmission_id:"003",start_time:"00:45",end_time:"03:30",type:"song",title:"Look Through My Window",primary_credit:"The Mamas & The Papas",source:"Deliver (Dunhill, 1967)",year:"1967",notes:"Album track.",confidence:"high"},
{id:"e011",transmission_id:"003",start_time:"03:30",end_time:"06:15",type:"song",title:"The Dance at the Gym",primary_credit:"West Side Story Cast",source:"Soundtrack (Columbia, 1961)",year:"1961",notes:"Mambo/Blues segment.",confidence:"high"},
{id:"e012",transmission_id:"003",start_time:"06:15",end_time:"08:30",type:"song",title:"Pray for Surf",primary_credit:"The Honeys",source:"Capitol (1963)",year:"1963",notes:"Studio production.",confidence:"high"},
{id:"e013",transmission_id:"003",start_time:"08:30",end_time:"10:45",type:"song",title:"Easy as 1-2-3",primary_credit:"Jan & Dean",source:"Liberty (1966)",year:"1966",notes:"Rare album track.",confidence:"medium"},
{id:"e014",transmission_id:"003",start_time:"10:45",end_time:"12:50",type:"song",title:"Run Run Run",primary_credit:"The Gestures",source:"Soma (1964)",year:"1964",notes:"Regional hit.",confidence:"high"},
{id:"e015",transmission_id:"003",start_time:"12:50",end_time:"15:20",type:"song",title:"Underdog",primary_credit:"Sly & The Family Stone",source:"Epic (1967)",year:"1967",notes:"Deep cut.",confidence:"high"},
{id:"e016",transmission_id:"003",start_time:"15:20",end_time:"18:00",type:"song",title:"Sarah Saturday",primary_credit:"Lazy Smoke",source:"Onyx (1968)",year:"1968",notes:"Rare pressing.",confidence:"medium"},
{id:"e017",transmission_id:"003",start_time:"18:00",end_time:"20:30",type:"song",title:"Tomorrow",primary_credit:"Strawberry Alarm Clock",source:"Uni (1967)",year:"1967",notes:"Album track.",confidence:"high"},
{id:"e018",transmission_id:"003",start_time:"20:30",end_time:"22:45",type:"song",title:"Mama Says",primary_credit:"The Beach Boys",source:"Friends (1968)",year:"1968",notes:"Album fragment.",confidence:"high"},
{id:"e019",transmission_id:"003",start_time:"22:45",end_time:"25:00",type:"song",title:"Going Out of My Head",primary_credit:"The Zombies",source:"1968",year:"1968",notes:"Alternate cut possible.",confidence:"high"},
{id:"e020",transmission_id:"003",start_time:"25:00",end_time:"27:15",type:"song",title:"Please No More Sad Songs",primary_credit:"The Idle Race",source:"1968",year:"1968",notes:"Pre-ELO credit.",confidence:"high"},
{id:"e021",transmission_id:"003",start_time:"27:15",end_time:"30:00",type:"song",title:"Compared to What",primary_credit:"Les McCann",source:"1969",year:"1969",notes:"Live capture.",confidence:"high"},
{id:"e022",transmission_id:"003",start_time:"30:00",end_time:"31:00",type:"song",title:"Lost in Space Theme",primary_credit:"TV Theme",source:"CBS (1965)",year:"1965",notes:"Opening title.",confidence:"high"},
{id:"e023",transmission_id:"003",start_time:"31:00",end_time:"33:30",type:"song",title:"In My Lonely Room",primary_credit:"Martha Reeves & The Vandellas",source:"1965",year:"1965",notes:"Motown cut.",confidence:"high"},
{id:"e024",transmission_id:"003",start_time:"33:30",end_time:"34:30",type:"spoken",title:"TV Clip",primary_credit:"Unknown",source:"Broadcast Fragment",year:"1964",notes:"Dialog excerpt.",confidence:"medium"},
{id:"e025",transmission_id:"003",start_time:"34:30",end_time:"35:00",type:"sound",title:"Audience Cheering",primary_credit:"Unknown",source:"Concert Film",year:"1964",notes:"Crowd wash.",confidence:"high"},
{id:"e026",transmission_id:"003",start_time:"35:00",end_time:"37:30",type:"song",title:"Live Performance Excerpt",primary_credit:"Unknown",source:"Concert Film",year:"1964",notes:"Short excerpt.",confidence:"high"},
{id:"e027",transmission_id:"003",start_time:"37:30",end_time:"39:00",type:"song",title:"Unverified Demo",primary_credit:"Unknown",source:"Bootleg Circulation",year:"1967",notes:"Unconfirmed source.",confidence:"low"},
{id:"e028",transmission_id:"003",start_time:"39:00",end_time:"41:15",type:"song",title:"2002 A Hit Song",primary_credit:"The Free Design",source:"1969",year:"1969",notes:"Baroque pop arrangement.",confidence:"high"},
{id:"e029",transmission_id:"003",start_time:"41:15",end_time:"43:30",type:"song",title:"Double Yellow Line",primary_credit:"The Music Machine",source:"1967",year:"1967",notes:"Single cut.",confidence:"high"},
{id:"e030",transmission_id:"003",start_time:"43:30",end_time:"45:45",type:"song",title:"She Loves You",primary_credit:"The Beatles",source:"1963",year:"1963",notes:"Single.",confidence:"high"},
{id:"e031",transmission_id:"003",start_time:"45:45",end_time:"48:30",type:"song",title:"God Only Knows",primary_credit:"The Beach Boys",source:"1966",year:"1966",notes:"Album track.",confidence:"high"},
{id:"e032",transmission_id:"003",start_time:"48:30",end_time:"49:30",type:"spoken",title:"Film Narration",primary_credit:"Unknown",source:"Film Fragment",year:"1953",notes:"Narration excerpt.",confidence:"medium"},
{id:"e033",transmission_id:"003",start_time:"49:30",end_time:"50:30",type:"spoken",title:"Film Dialog",primary_credit:"Unknown",source:"Film Fragment",year:"1964",notes:"Dialog excerpt.",confidence:"medium"},
{id:"e034",transmission_id:"003",start_time:"50:30",end_time:"54:00",type:"song",title:"Solo Piano Performance",primary_credit:"Unknown",source:"TV Special",year:"1967",notes:"Short performance.",confidence:"high"},
{id:"e035",transmission_id:"003",start_time:"00:08",end_time:"00:23",type:"jingle",title:"Radio Sting",primary_credit:"Station Singers",source:"Station Kit",year:"1967",notes:"Identification sting.",confidence:"high"},
{id:"e038",transmission_id:"003",start_time:"12:08",end_time:"12:15",type:"unknown",title:"Morse Pattern",primary_credit:"Unknown",source:"Unknown",year:null,notes:"Rhythmic beeping. Interference.",confidence:"low"},
{id:"e039",transmission_id:"003",start_time:"28:45",end_time:"28:52",type:"unknown",title:"Distorted Music Fragment",primary_credit:"Unknown",source:"Unknown",year:null,notes:"Heavily degraded. Unconfirmed.",confidence:"low"}
]
};


const qs = (sel, root=document) => root.querySelector(sel);
const qsa = (sel, root=document) => Array.from(root.querySelectorAll(sel));

function pad2(n){ return String(n).padStart(2,'0'); }

function makeSessionId(){
const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
let out = '';
for(let i=0;i<8;i++){ out += chars[Math.floor(Math.random()*chars.length)]; }
return out;
}

class App {
constructor(){
this.data = D;
this.appEl = qs('#app');

this.overlay = qs('#session-overlay');
this.aliasInput = qs('#alias-input');
this.enterBtn = qs('#enter-btn');
this.sessionIndicator = qs('#session-indicator');

this.navTrans = qs('#nav-transmissions');
this.navInfo = qs('#nav-info');

this.session = {
alias: sessionStorage.getItem('wlsn_alias') || '',
id: sessionStorage.getItem('wlsn_session_id') || '',
start: Number(sessionStorage.getItem('wlsn_session_start') || 0)
};

this.chatBots = [
{name:'djmoondust',location:'Portland, OR'},
{name:'tape_hound',location:'London, UK'},
{name:'freq_drift',location:'Tokyo, JP'},
{name:'vinyl_archive',location:'Melbourne, AU'},
{name:'signal_lost',location:'Brooklyn, NY'},
{name:'reel_to_reel',location:'Berlin, DE'}
];

this.botMessages = [
{bot:1,text:"001: anyone else catch the dip right after the ident? feels like the deck grabbed.",reply:true},
{bot:3,text:"003 opens with a clean weather tag, but the noise floor feels off for an aircheck."},
{bot:0,text:"The WLSN ident shows up more than once, but never the same length twice."},
{bot:4,text:"02:18 in 001: that whistle again. quiet, same band.",reply:true},
{bot:2,text:"I tried matching the cereal spot in 003. close, not exact. maybe a different cut?"},
{bot:5,text:"Hard splice at 03:22 on 002, then it returns brighter. two passes?",reply:true},
{bot:1,text:"If it was rebroadcast, why keep the bleed? feels like the bleed is the point."},
{bot:3,text:"Tape box handwriting switches formats mid-run. month/day once, then day.month."},
{bot:0,text:"The ident consonants smear like it was played off a speaker into a mic.",reply:true},
{bot:4,text:"Some tracks run a hair fast. could be speed drift, could be source.",reply:true},
{bot:2,text:"Anyone recognize the four note chime? feels like a station kit."},
{bot:5,text:"I keep hearing room tone under the music. like another space underneath.",reply:true},
{bot:1,text:"003: the word 'network' pops once, then disappears. too clean to be accidental."},
{bot:3,text:"That word sits on top of the hiss, not inside it."},
{bot:0,text:"Reminder: tag artifacts separately from tracks. this is not a playlist.",reply:true},
{bot:4,text:"Ghost note under the tone in 001. could be a second deck running.",reply:true}
];

this.slides = [
{src:"images/wlsn-01.jpg",caption:"ARCHIVE IMAGE 01"}
];

this._uptimeTimer = null;
this._chatTimer = null;
this._slideTimer = null;

// Element modal (redesigned)
this.elementModal = qs('#element-modal');
this.elementModalTitle = qs('#element-modal-title');
this.elementClose = qs('#element-close');

// Persistent player
this.persistentAudio = qs('#pp-audio');
this.persistentPlayer = qs('#persistent-player');
this.persistentTitle = qs('#pp-title');
this.persistentPlay = qs('#pp-play');
this.persistentTimeline = qs('#pp-timeline');
this.persistentProgress = qs('#pp-progress');
this.persistentTime = qs('#pp-time');
this.persistentHide = qs('#pp-hide');
}

init(){
this.bindSessionGate();
this.bindRouter();
this.bindPersistentPlayer();
this.bindElementModal();
this.ensureSession();
this.renderRoute();
this.startUptime();
}

bindSessionGate(){
const submit = () => {
const alias = (this.aliasInput.value || '').trim().toUpperCase();
if(!alias){
this.aliasInput.focus();
return;
}
this.session.alias = alias.toUpperCase();
sessionStorage.setItem('wlsn_alias', this.session.alias);

if(!this.session.id){
this.session.id = makeSessionId();
sessionStorage.setItem('wlsn_session_id', this.session.id);
}

if(!this.session.start){
this.session.start = Date.now();
sessionStorage.setItem('wlsn_session_start', String(this.session.start));
}

this.hideOverlay();
this.updateSessionPanel();
};

this.enterBtn.addEventListener('click', submit);
this.aliasInput.addEventListener('keydown', (e) => {
if(e.key === 'Enter') submit();
});
}

ensureSession(){
if(this.session.alias && this.session.start){
if(!this.session.id){
this.session.id = makeSessionId();
sessionStorage.setItem('wlsn_session_id', this.session.id);
}
this.hideOverlay();
this.updateSessionPanel();
return;
}
this.showOverlay();
this.updateSessionPanel(true);
setTimeout(() => this.aliasInput.focus(), 60);
}

showOverlay(){
this.overlay.classList.add('active');
this.overlay.setAttribute('aria-hidden','false');
}

hideOverlay(){
this.overlay.classList.remove('active');
this.overlay.setAttribute('aria-hidden','true');
}

startUptime(){
if(this._uptimeTimer) clearInterval(this._uptimeTimer);
this._uptimeTimer = setInterval(() => this.updateSessionPanel(), 1000);
}

updateSessionPanel(isLocked=false){
const alias = this.session.alias || 'UNIDENTIFIED';
const id = this.session.id || '--------';

let uptime = '00:00:00';
if(this.session.start){
const s = Math.max(0, Math.floor((Date.now() - this.session.start) / 1000));
const h = Math.floor(s / 3600);
const m = Math.floor((s % 3600) / 60);
const sec = s % 60;
uptime = `${pad2(h)}:${pad2(m)}:${pad2(sec)}`;
}

this.sessionIndicator.innerHTML = isLocked
? `ACCESS LOCKED | <b>IDENTIFICATION REQUIRED</b>`
: `LOGGED AS <b>${alias}</b> | SESSION <b>${id}</b> | UPTIME <b>${uptime}</b>`;
}

bindRouter(){
window.addEventListener('hashchange', () => this.renderRoute());

const go = (hash) => {
if(location.hash !== hash) location.hash = hash;
else this.renderRoute();
};

this.navTrans.addEventListener('click', (e) => {
e.preventDefault();
go('#transmissions');
});
this.navInfo.addEventListener('click', (e) => {
e.preventDefault();
go('#info');
});
}

setActiveNav(route){
this.navTrans.classList.remove('active');
this.navInfo.classList.remove('active');
if(route === 'info') this.navInfo.classList.add('active');
else this.navTrans.classList.add('active');
}

renderRoute(){
const hash = (location.hash || '#transmissions').replace(/^#/, '');
const parts = hash.split('/').filter(Boolean);

this.stopTimers();

if(parts[0] === 'info'){
this.setActiveNav('info');
this.renderInfo();
return;
}

this.setActiveNav('transmissions');

if(parts[0] === 'transmissions' && parts[1]){
this.renderTransmission(parts[1]);
return;
}

this.renderArchive();
}

stopTimers(){
if(this._chatTimer) clearInterval(this._chatTimer);
if(this._slideTimer) clearInterval(this._slideTimer);
this._chatTimer = null;
this._slideTimer = null;
this.stopOscilloscope();
}

initOscilloscope(){
const canvas = qs('#scope-canvas');
const status = qs('.scope-status');
if(!canvas) return;

const ctx = canvas.getContext('2d');
const audio = this.persistentAudio;

// Set canvas size
const container = canvas.parentElement;
const size = container.offsetWidth;
canvas.width = size;
canvas.height = size;

// Create audio context and analyser
if(!this.audioContext){
this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
}

if(!this.analyser){
this.analyser = this.audioContext.createAnalyser();
this.analyser.fftSize = 2048;
}

// Connect audio element to analyser if not already connected
if(!this.audioSource){
this.audioSource = this.audioContext.createMediaElementSource(audio);
this.audioSource.connect(this.analyser);
this.analyser.connect(this.audioContext.destination);
}

const bufferLength = this.analyser.frequencyBinCount;
const dataArray = new Uint8Array(bufferLength);

if(status) status.textContent = 'SIGNAL ACQUIRED - ANALYZING';

let rotation = 0;
let trails = [];
const maxTrails = 60;

const draw = () => {
this.scopeAnimationFrame = requestAnimationFrame(draw);

// Get waveform data
this.analyser.getByteTimeDomainData(dataArray);

// Clear with fade effect (phosphor persistence)
ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
ctx.fillRect(0, 0, canvas.width, canvas.height);

// Draw new waveform
ctx.strokeStyle = '#28d428';
ctx.lineWidth = 2;
ctx.shadowBlur = 10;
ctx.shadowColor = 'rgba(40, 212, 40, 0.8)';

// Create Lissajous curve (X-Y mode oscilloscope)
ctx.beginPath();
const centerX = canvas.width / 2;
const centerY = canvas.height / 2;
const radius = canvas.width * 0.35;

let firstPoint = true;

for(let i = 0; i < bufferLength; i += 2){
const x = dataArray[i];
const y = dataArray[i + 1] || dataArray[i];

// Normalize to -1 to 1
const normalX = (x / 128.0) - 1.0;
const normalY = (y / 128.0) - 1.0;

// Apply rotation for visual interest
const angle = rotation * 0.01;
const rotX = normalX * Math.cos(angle) - normalY * Math.sin(angle);
const rotY = normalX * Math.sin(angle) + normalY * Math.cos(angle);

const plotX = centerX + rotX * radius;
const plotY = centerY + rotY * radius;

if(firstPoint){
ctx.moveTo(plotX, plotY);
firstPoint = false;
} else {
ctx.lineTo(plotX, plotY);
}
}

ctx.stroke();

// Add some visual variation based on audio
const avgAmplitude = dataArray.reduce((a,b) => a + b, 0) / bufferLength;
const intensity = Math.abs(avgAmplitude - 128) / 128;

rotation += intensity * 2;

// Brighter glow when audio is louder
ctx.shadowBlur = 10 + intensity * 15;
};

// Start animation
draw();

// Update status when audio plays/pauses
audio.addEventListener('play', () => {
if(status) status.textContent = 'SIGNAL ACTIVE - DECODING';
});

audio.addEventListener('pause', () => {
if(status) status.textContent = 'SIGNAL PAUSED';
});
}

stopOscilloscope(){
if(this.scopeAnimationFrame){
cancelAnimationFrame(this.scopeAnimationFrame);
this.scopeAnimationFrame = null;
}
}

bindPersistentPlayer(){
const fmt = (t) => {
if(!isFinite(t)) return '00:00';
const m = Math.floor(t / 60);
const s = Math.floor(t % 60);
return `${pad2(m)}:${pad2(s)}`;
};

const sync = () => {
const cur = this.persistentAudio.currentTime || 0;
const dur = this.persistentAudio.duration || 0;
this.persistentTime.textContent = `${fmt(cur)} / ${fmt(dur)}`;

if(dur > 0){
const p = Math.max(0, Math.min(1, cur / dur));
const pct = (p * 100);
this.persistentProgress.style.width = `${pct}%`;
}
};

this.persistentAudio.addEventListener('timeupdate', sync);
this.persistentAudio.addEventListener('loadedmetadata', sync);
this.persistentAudio.addEventListener('ended', () => {
this.persistentPlay.textContent = '▶';
});

this.persistentPlay.addEventListener('click', () => {
if(this.persistentAudio.paused){
this.persistentAudio.play();
this.persistentPlay.textContent = '❚❚';
} else {
this.persistentAudio.pause();
this.persistentPlay.textContent = '▶';
}
});

this.persistentTimeline.addEventListener('click', (e) => {
const r = this.persistentTimeline.getBoundingClientRect();
const p = (e.clientX - r.left) / r.width;
const clamped = Math.max(0, Math.min(1, p));
if(this.persistentAudio.duration){
this.persistentAudio.currentTime = clamped * this.persistentAudio.duration;
}
});

this.persistentHide.addEventListener('click', () => {
this.persistentAudio.pause();
this.persistentPlayer.classList.remove('active');
this.persistentPlayer.setAttribute('aria-hidden','true');
this.persistentPlay.textContent = '▶';
});
}

bindElementModal(){
this.elementClose.addEventListener('click', () => {
this.stopElementAudio();
this.elementModal.classList.remove('active');
this.elementModal.setAttribute('aria-hidden','true');
});

this.elementModal.addEventListener('click', (e) => {
if(e.target === this.elementModal){
this.stopElementAudio();
this.elementModal.classList.remove('active');
this.elementModal.setAttribute('aria-hidden','true');
}
});
}

stopElementAudio(){
const audio = qs('#element-audio');
if(audio){
audio.pause();
audio.currentTime = 0;
}
}

showElementDetail(elementId){
const element = this.data.elements.find(e => e.id === elementId);
if(!element) return;

// Set title
this.elementModalTitle.textContent = element.title;

// Set image
const imageEl = qs('#element-modal-image-src');
if(element.imageUrl){
imageEl.src = element.imageUrl;
imageEl.style.display = 'block';
} else {
imageEl.style.display = 'none';
}

// Set audio
const audioEl = qs('#element-modal-audio');
if(element.audioUrl){
audioEl.src = element.audioUrl;
} else {
audioEl.removeAttribute('src');
}

// Build metadata grid
const confClass = element.confidence === 'high' ? 'confidence-high' : 
                  (element.confidence === 'medium' ? 'confidence-medium' : 'confidence-low');

const metaEl = qs('#element-modal-meta');
metaEl.innerHTML = `
<span class="k">Timecode</span>
<span class="v">${element.start_time} – ${element.end_time}</span>

<span class="k">Type</span>
<span class="v"><span class="type-badge">${element.type}</span></span>

<span class="k">Title</span>
<span class="v">${element.title}</span>

<span class="k">Artist</span>
<span class="v">${element.primary_credit}</span>

<span class="k">Year</span>
<span class="v">${element.year || 'Unknown'}</span>

<span class="k">Logged By</span>
<span class="v">${element.logged_by || 'WLSN Archive'}</span>

<span class="k">Confidence</span>
<span class="v"><span class="${confClass}">${String(element.confidence || '').toUpperCase()}</span></span>
`;

// Set source and notes
const sourceEl = qs('#element-modal-source');
const notesEl = qs('#element-modal-notes');
sourceEl.textContent = element.source || 'Unknown';
notesEl.textContent = element.notes || 'No additional notes available.';

// Show modal
this.elementModal.classList.add('active');
this.elementModal.setAttribute('aria-hidden', 'false');

// Bind player
setTimeout(() => this.bindElementPlayer(), 0);
}

bindElementPlayer(){
const audio = qs('#element-modal-audio');
const playBtn = qs('#element-modal-play');
const timeline = qs('#element-modal-timeline');
const progress = qs('#element-modal-progress');
const timeEl = qs('#element-modal-time');

if(!audio || !playBtn) return;

const fmt = (t) => {
if(!isFinite(t)) return '00:00';
const m = Math.floor(t / 60);
const s = Math.floor(t % 60);
return `${pad2(m)}:${pad2(s)}`;
};

const sync = () => {
const cur = audio.currentTime || 0;
const dur = audio.duration || 0;
timeEl.textContent = `${fmt(cur)} / ${fmt(dur)}`;

if(dur > 0){
const p = Math.max(0, Math.min(1, cur / dur));
progress.style.width = `${p * 100}%`;
}
};

audio.addEventListener('loadedmetadata', sync);
audio.addEventListener('timeupdate', sync);

audio.addEventListener('ended', () => {
playBtn.textContent = '▶ PLAY SOURCE';
this.stopElementScope();
});

playBtn.addEventListener('click', () => {
if(audio.paused){
audio.play();
playBtn.textContent = '❚❚ PAUSE';
this.startElementScope();
} else {
audio.pause();
playBtn.textContent = '▶ PLAY SOURCE';
this.stopElementScope();
}
});

timeline.addEventListener('click', (e) => {
const r = timeline.getBoundingClientRect();
const p = (e.clientX - r.left) / r.width;
if(audio.duration){
audio.currentTime = p * audio.duration;
}
});

sync();
}

startElementScope(){
const canvas = qs('#element-modal-scope');
if(!canvas) return;

const ctx = canvas.getContext('2d');
const audio = qs('#element-modal-audio');

// Create audio context
if(!this.elementAudioContext){
this.elementAudioContext = new (window.AudioContext || window.webkitAudioContext)();
}

if(!this.elementAnalyser){
this.elementAnalyser = this.elementAudioContext.createAnalyser();
this.elementAnalyser.fftSize = 1024;
}

if(!this.elementAudioSource){
try{
this.elementAudioSource = this.elementAudioContext.createMediaElementSource(audio);
this.elementAudioSource.connect(this.elementAnalyser);
this.elementAnalyser.connect(this.elementAudioContext.destination);
} catch(e){
console.error('Could not create audio source:', e);
return;
}
}

const bufferLength = this.elementAnalyser.frequencyBinCount;
const dataArray = new Uint8Array(bufferLength);

let rotation = 0;

const draw = () => {
this.elementScopeFrame = requestAnimationFrame(draw);

this.elementAnalyser.getByteTimeDomainData(dataArray);

// Fade effect (phosphor persistence)
ctx.fillStyle = 'rgba(0, 0, 0, 0.18)';
ctx.fillRect(0, 0, 70, 70);

// Draw Lissajous pattern
ctx.strokeStyle = '#28d428';
ctx.lineWidth = 1.2;
ctx.shadowBlur = 5;
ctx.shadowColor = 'rgba(40, 212, 40, 0.8)';

ctx.beginPath();
const centerX = 35;
const centerY = 35;
const radius = 25;

for(let i = 0; i < bufferLength; i += 2){
const x = dataArray[i];
const y = dataArray[i + 1] || dataArray[i];

const normalX = (x / 128.0) - 1.0;
const normalY = (y / 128.0) - 1.0;

const angle = rotation * 0.01;
const rotX = normalX * Math.cos(angle) - normalY * Math.sin(angle);
const rotY = normalX * Math.sin(angle) + normalY * Math.cos(angle);

const plotX = centerX + rotX * radius;
const plotY = centerY + rotY * radius;

if(i === 0) ctx.moveTo(plotX, plotY);
else ctx.lineTo(plotX, plotY);
}

ctx.stroke();

const avgAmplitude = dataArray.reduce((a,b) => a + b, 0) / bufferLength;
const intensity = Math.abs(avgAmplitude - 128) / 128;
rotation += intensity * 2;
};

draw();
}

stopElementScope(){
if(this.elementScopeFrame){
cancelAnimationFrame(this.elementScopeFrame);
this.elementScopeFrame = null;
}
}

stopElementAudio(){
const audio = qs('#element-modal-audio');
if(audio){
audio.pause();
audio.currentTime = 0;
}
this.stopElementScope();
}

loadToPersistentPlayer(url, title){
if(!url){
this.persistentTitle.textContent = 'None';
this.persistentAudio.removeAttribute('src');
this.persistentAudio.load();
this.persistentPlayer.classList.remove('active');
this.persistentPlayer.setAttribute('aria-hidden','true');
return;
}

this.persistentTitle.textContent = title || 'Untitled';
this.persistentAudio.src = url;
this.persistentPlayer.classList.add('active');
this.persistentPlayer.setAttribute('aria-hidden','false');

this.persistentAudio.play().then(() => {
this.persistentPlay.textContent = '❚❚';
}).catch(()=>{
this.persistentPlay.textContent = '▶';
});
}

renderArchive(){
const latest = this.data.transmissions[this.data.transmissions.length - 1];

this.appEl.innerHTML = `
<section class="feature">
<div class="feature-title">Latest Transmission</div>
<p>TRANSMISSION ${latest.id} | ${latest.title} | ${latest.dateFormatted}</p>
<div style="margin-top:14px;">
<a class="btn" href="#transmissions/${latest.id}" style="display:inline-block;min-width:260px;text-align:center;">OPEN LATEST</a>
</div>
</section>

<div class="grid" id="tx-grid"></div>
`;

const grid = qs('#tx-grid');
grid.innerHTML = this.data.transmissions.slice(0,-1).map(t => {
return `
<div class="card" data-id="${t.id}">
<div class="card-id">TRANSMISSION ${t.id}</div>
<div class="card-title">${t.title}</div>
<div class="card-date">${t.dateFormatted}</div>
<div class="card-desc">${t.description}</div>
</div>
`;
}).join('');

qsa('.card', grid).forEach(card => {
card.addEventListener('click', () => {
location.hash = `#transmissions/${card.getAttribute('data-id')}`;
});
});
}

renderTransmission(id){
const tx = this.data.transmissions.find(t => t.id === id);
if(!tx){
this.appEl.innerHTML = `<a class="back-link" href="#transmissions">Back to Transmission Archive</a><div class="intro"><h1>Transmission Not Found</h1><p>No record for TRANSMISSION ${id}.</p></div>`;
return;
}

const elements = this.data.elements.filter(e => e.transmission_id === tx.id);

const audioSection = tx.audioUrl ? `
<div class="oscilloscope-player">
<div class="section-title" style="margin-bottom:14px;">Audio Playback</div>
<p style="opacity:0.82;margin-bottom:14px;font-size:12px;">Click play to load this transmission into the persistent player.</p>
<div class="player-layout">
<div class="player-main">
<button class="btn" id="load-audio" type="button" style="width:100%;max-width:360px;">LOAD TRANSMISSION ${tx.id}</button>
</div>
<div class="player-scope">
<div class="scope-container">
<div class="scope-display">
<canvas id="scope-canvas" class="scope-canvas"></canvas>
<div class="scope-grid"></div>
</div>
<div class="scope-label">Signal Monitor</div>
</div>
</div>
</div>
</div>
` : `
<div class="section">
<div class="section-title">Audio Playback</div>
<p style="opacity:0.75;">Audio file not yet linked for this transmission.</p>
</div>
`;

this.appEl.innerHTML = `
<a class="back-link" href="#transmissions">Back to Transmission Archive</a>

<div class="transmission-header">
<div class="transmission-id">TRANSMISSION ${tx.id}</div>
<div class="transmission-title">${tx.title}</div>
<div class="transmission-date">RECORDED: ${tx.dateFormatted}</div>
<div style="margin-top:12px;opacity:0.82;">${tx.notes}</div>
</div>

${audioSection}

<div class="section">
<div class="section-title">Signal Elements</div>

<div class="transmission-filters">
<input id="filter-q" type="text" placeholder="Search title, credit, notes" autocomplete="off" />
<select id="filter-type">
<option value="">All types</option>
${Array.from(new Set(elements.map(e => e.type))).sort().map(t => `<option value="${t}">${t}</option>`).join('')}
</select>
</div>

<table class="breakdown-table">
<thead>
<tr>
<th>TIME</th>
<th>TYPE</th>
<th>TITLE</th>
<th>CREDIT</th>
<th>CONF</th>
</tr>
</thead>
<tbody id="elements-body"></tbody>
</table>
</div>
`;

if(tx.audioUrl){
const loadBtn = qs('#load-audio');
if(loadBtn){
loadBtn.addEventListener('click', () => {
this.loadToPersistentPlayer(tx.audioUrl, `TRANSMISSION ${tx.id} - ${tx.title}`);
this.initOscilloscope();
});
}
}

const body = qs('#elements-body');
const renderRows = () => {
const q = (qs('#filter-q').value || '').trim().toLowerCase();
const type = qs('#filter-type').value;

const rows = elements.filter(e => {
if(type && e.type !== type) return false;
if(!q) return true;
const blob = `${e.title} ${e.primary_credit} ${e.notes || ''} ${e.source || ''}`.toLowerCase();
return blob.includes(q);
});

body.innerHTML = rows.map(e => {
const confClass = e.confidence === 'high' ? 'confidence-high' : (e.confidence === 'medium' ? 'confidence-medium' : 'confidence-low');
return `
<tr>
<td>${e.start_time}–${e.end_time}</td>
<td><span class="type-badge">${e.type}</span></td>
<td><span class="element-link" data-element-id="${e.id}">${e.title}</span></td>
<td>${e.primary_credit}</td>
<td class="${confClass}">${String(e.confidence || '').toUpperCase()}</td>
</tr>
`;
}).join('');

if(rows.length === 0){
body.innerHTML = `<tr><td colspan="5" style="opacity:0.7;">No matches.</td></tr>`;
}

// Bind click handlers to element links
qsa('.element-link', body).forEach(link => {
link.addEventListener('click', () => {
const elementId = link.getAttribute('data-element-id');
this.showElementDetail(elementId);
});
});
};

qs('#filter-q').addEventListener('input', renderRows);
qs('#filter-type').addEventListener('change', renderRows);
renderRows();
}

renderInfo(){
this.appEl.innerHTML = `
<section class="intro">
<h1>Info</h1>
<p>WLSN is an archive for transmissions, source notes, and linked media. Use this page to scan discussion, browse images, and grab the podcast feed.</p>
</section>

<div class="info-shell">
<div class="info-grid">
<div>
<div class="section">
<div class="section-title">Discussion</div>
<div class="chat-container">
<div class="chat-log" id="chat-log"></div>
</div>

<div class="chat-input-area" style="margin-top:12px;">
<input id="chat-input" type="text" placeholder="ENTER NOTE..." autocomplete="off" />
<button class="btn" id="chat-send" type="button">SEND</button>
</div>
</div>
</div>

<div>
<div class="section" style="margin-top:0;">
<div class="section-title">Archive Images</div>
<div class="slideshow-stage" id="stage"><div class="slideshow-caption" id="stage-caption"></div></div>
</div>

<div class="section" style="margin-top:16px;">
<div class="section-title">Archive Updates</div>
<input id="email" type="email" placeholder="EMAIL" autocomplete="off" style="width:100%;font-family:var(--mono);font-size:11px;padding:10px 12px;border:1px solid var(--crt-green);background:rgba(0,0,0,0.35);color:var(--crt-green);margin-bottom:10px;outline:none;" />
<button class="btn" id="sub" type="button" style="width:100%;">SUBSCRIBE</button>
<div class="message" id="msg"></div>
</div>

<div class="section" style="margin-top:16px;">
<div class="section-title">Podcast Feed (RSS)</div>
<input id="rss-url" type="text" value="https://wlsn.space/feed.xml" readonly style="width:100%;font-family:var(--mono);font-size:11px;padding:10px 12px;border:1px solid var(--crt-green);background:rgba(0,0,0,0.35);color:var(--crt-green);outline:none;margin-bottom:10px;" />
<button class="btn" id="copy-rss" type="button" style="width:100%;">COPY TO CLIPBOARD</button>
</div>
</div>
</div>
</div>
`;
this.bindChat();
this.bindNewsletter();
this.bindSlideshow();

const copyBtn = qs('#copy-rss');
const rssInput = qs('#rss-url');
if(copyBtn && rssInput){
copyBtn.addEventListener('click', async () => {
try{
await navigator.clipboard.writeText(rssInput.value);
const old = copyBtn.textContent;
copyBtn.textContent = 'COPIED';
setTimeout(() => copyBtn.textContent = old, 900);
}catch(e){
rssInput.focus();
rssInput.select();
}
});
}
}

bindChat(){
const log = qs('#chat-log');
const input = qs('#chat-input');
const send = qs('#chat-send');
if(!log || !input || !send) return;

const pushMsg = (who, text, meta) => {
const ts = new Date();
const stamp = `${pad2(ts.getHours())}:${pad2(ts.getMinutes())}`;
const extra = meta ? `<span class="chat-location">${meta}</span>` : '';
const cls = who === 'USER' ? 'chat-user' : 'chat-bot';
const name = who === 'USER' ? (this.session.alias || 'UNIDENTIFIED') : who;

const el = document.createElement('div');
el.className = 'chat-msg';
el.innerHTML = `
<span class="chat-timestamp">${stamp}</span>
<span class="${cls}">${name}</span>${extra}
<div style="opacity:0.86; margin-left:42px;">${text.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
`;
log.appendChild(el);
log.parentElement.scrollTop = log.parentElement.scrollHeight;
};

const postUser = () => {
const t = (input.value || '').trim();
if(!t) return;
input.value = '';
pushMsg('USER', t);
};

send.addEventListener('click', postUser);
input.addEventListener('keydown', (e) => {
if(e.key === 'Enter') postUser();
});

// Seed a few messages
for(let i=0;i<6;i++){
const m = this.botMessages[i];
const b = this.chatBots[m.bot];
pushMsg(b.name, m.text, b.location);
}

let idx = 6;
this._chatTimer = setInterval(() => {
if(idx >= this.botMessages.length) return;
const m = this.botMessages[idx++];
const b = this.chatBots[m.bot];
pushMsg(b.name, m.text, b.location);
}, 3800);
}

bindNewsletter(){
const email = qs('#email');
const sub = qs('#sub');
const msg = qs('#msg');
if(!email || !sub || !msg) return;

const show = (text, ok=true) => {
msg.className = 'message ' + (ok ? 'success' : 'error');
msg.style.display = 'block';
msg.textContent = text;
};

sub.addEventListener('click', () => {
const v = (email.value || '').trim();
if(!v || !v.includes('@')){
show('INVALID EMAIL', false);
return;
}
show('RECEIVED. INDEXING PENDING.', true);
email.value = '';
});
}

bindSlideshow(){
const stage = qs('#stage');
const caption = qs('#stage-caption');
if(!stage) return;

stage.innerHTML = '';

const first = (this.slides && this.slides[0]) ? this.slides[0] : null;
if(!first || !first.src){
stage.innerHTML = `<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;opacity:0.75;letter-spacing:2px;font-size:10px;">NO IMAGES LINKED YET</div>`;
if(caption) caption.textContent = '';
return;
}

const img = document.createElement('img');
img.src = first.src;
img.alt = first.caption || 'WLSN image';
img.classList.add('active');
img.addEventListener('error', () => {
stage.innerHTML = `<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;opacity:0.75;letter-spacing:2px;font-size:10px;">NO IMAGES LINKED YET</div>`;
if(caption) caption.textContent = '';
});
stage.appendChild(img);

if(caption) caption.textContent = first.caption || '';
}
}

window.addEventListener('DOMContentLoaded', () => {
const app = new App();
app.init();
});

</script>
</body>
</html>
