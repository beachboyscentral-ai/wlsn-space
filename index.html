<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WLSN | Western Light and Sound Network</title>

  <!-- Favicons (keep these files in your site root) -->
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --crt-green:#28d428;
      --crt-dim:#0d5a0d;
      --crt-bg:#0b110b;
      --crt-glow:rgba(40,212,40,0.55);
      --mono:'Courier New',monospace;
    }

    body{
      font-family:var(--mono);
      background:var(--crt-bg);
      color:var(--crt-green);
      line-height:1.6;
      font-size:13px;
      text-shadow:0 0 3px var(--crt-glow);
    }

    body::before{
      content:'';
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:repeating-linear-gradient(
        0deg,
        rgba(0,0,0,0.16) 0px,
        rgba(0,0,0,0.16) 1px,
        transparent 1px,
        transparent 2px
      );
      pointer-events:none;
      z-index:9999;
      mix-blend-mode:normal;
      opacity:0.9;
    }

    .container{max-width:1000px;margin:0 auto;padding:40px 20px}

    header{
      border-top:2px solid var(--crt-green);
      border-bottom:2px solid var(--crt-green);
      padding:20px 0;
      margin-bottom:28px;
    }

    .logo{
      font-size:36px;
      font-weight:700;
      letter-spacing:12px;
      margin-bottom:10px;
      text-shadow:0 0 8px var(--crt-glow);
      line-height:1.1;
    }

    /* Cursor sizing and alignment */
    .logo .cursor{
      font-size:22px;
      line-height:1;
      display:inline-block;
      vertical-align:baseline;
      margin-left:8px;
      animation:blink 1s infinite;
      position:relative;
      top:-5px;
      opacity:0.95;
    }

    .tagline{
      font-size:11px;
      letter-spacing:2px;
      color:#4a9a4a;
      text-transform:uppercase;
      opacity:0.75;
    }

    /* Make "Signal Archive" slightly blurrier */
    .tagline-sub{
      margin-top:2px;
      opacity:0.62;
      filter: blur(1.15px);
    }

    /* Session indicator is its own panel, not part of nav banner */
    .session-panel{
      margin-top:14px;
      border:1px solid var(--crt-dim);
      background:rgba(0,0,0,0.28);
      padding:10px 12px;
      font-size:10px;
      letter-spacing:2px;
      color:var(--crt-dim);
      opacity:0.95;
      filter: blur(0.25px);
    }
    .session-panel b{color:var(--crt-green);font-weight:400;filter:none}

    nav{
      margin-top:18px;
      padding-top:18px;
      border-top:1px solid var(--crt-dim);
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    /* Sitewide button rule:
       - default: black fill + green outline
       - hover: green fill + glow
    */
    .btn,
    .btn:visited,
    nav a,
    nav a:visited{
      display:inline-block;
      background:transparent;
      color:var(--crt-green);
      padding:12px 18px;
      text-decoration:none;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:2px;
      font-weight:700;
      border:2px solid var(--crt-green);
      cursor:pointer;
      transition:background .08s, color .08s, box-shadow .08s, opacity .08s;
    }

    .btn:hover,
    nav a:hover{
      background:var(--crt-green);
      color:var(--crt-bg);
      box-shadow:0 0 14px rgba(0,255,102,0.25);
    }

    nav a.active{
      opacity:1;
      box-shadow:0 0 14px rgba(0,255,102,0.18);
    }

    /* keep nav alignment even */
    nav a{
      text-align:center;
      min-width:200px;
    }

    /* remove old hover-highlighting on large boxes */
    .no-card-hover:hover{background:transparent !important}

    .intro{
      border:1px solid var(--crt-dim);
      border-left:4px solid var(--crt-green);
      padding:26px;
      margin-bottom:24px;
      background:rgba(0,0,0,0.18);
    }
    .intro h1{
      font-size:14px;
      margin-bottom:14px;
      text-transform:uppercase;
      letter-spacing:2px;
      font-weight:700;
      border-bottom:1px solid var(--crt-green);
      padding-bottom:8px;
    }
    .intro p{margin-bottom:12px;line-height:1.8;opacity:0.86}

    .back-link{
      display:inline-block;
      margin-bottom:18px;
      color:var(--crt-green);
      text-decoration:none;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:1px;
      opacity:0.7;
    }
    .back-link:hover{opacity:1}
    .back-link::before{content:'← '}

    .grid{display:block;margin-top:16px;border:1px solid var(--crt-dim)}
    .card{
      border-bottom:1px solid var(--crt-dim);
      padding:20px 18px;
      cursor:pointer;
      background:rgba(0,0,0,0.10);
    }
    .card:hover{background:rgba(51,255,51,0.05)}
    .card-id{font-size:10px;color:var(--crt-green);margin-bottom:8px;letter-spacing:1.5px;font-weight:700;opacity:0.7}
    .card-title{font-size:16px;font-weight:700;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px}
    .card-date{font-size:10px;color:var(--crt-dim);margin-bottom:10px;opacity:0.7}
    .card-desc{font-size:13px;line-height:1.6;opacity:0.82}

    /* Feature block on archive landing */
    .feature{
      border:1px solid var(--crt-dim);
      border-left:4px solid var(--crt-green);
      padding:18px;
      margin:18px 0 22px;
      background:rgba(0,0,0,0.18);
    }
    .feature .feature-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:2px;
      opacity:0.85;
      margin-bottom:10px;
      border-bottom:1px solid var(--crt-green);
      padding-bottom:8px;
      font-weight:700;
    }
    .feature p{opacity:0.82}

    /* Badges (not buttons) */
    .badge{
      display:inline-block;
      padding:6px 10px;
      border:1px dashed var(--crt-dim);
      color:var(--crt-green);
      background:rgba(0,0,0,0.22);
      letter-spacing:2px;
      font-size:10px;
      cursor:default;
      user-select:none;
      opacity:0.95;
    }
    .badge.received{border-color:var(--crt-green)}
    .badge.archived{border-color:var(--crt-dim);filter:blur(0.15px)}
    .badge:hover{background:rgba(0,0,0,0.22);box-shadow:none}

    .transmission-header{
      border:2px solid var(--crt-green);
      padding:26px;
      margin-bottom:22px;
      background:rgba(0,0,0,0.14);
    }
    .transmission-id{font-size:10px;margin-bottom:10px;letter-spacing:2px;font-weight:700;opacity:0.7}
    .transmission-title{font-size:22px;font-weight:700;margin-bottom:8px;text-transform:uppercase;letter-spacing:1px}
    .transmission-date{font-size:10px;color:var(--crt-dim);margin-bottom:14px;opacity:0.7}

    .section{
      border:1px solid var(--crt-dim);
      border-left:3px solid var(--crt-dim);
      padding:18px;
      margin-bottom:18px;
      background:rgba(0,0,0,0.14);
    }
    .section-title{
      font-size:11px;text-transform:uppercase;letter-spacing:2px;margin-bottom:14px;
      border-bottom:1px solid var(--crt-green);padding-bottom:8px;font-weight:700
    }

    .breakdown-table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      border:1px solid var(--crt-dim);
      margin:14px 0 18px;
    }
    .breakdown-table thead{background:rgba(51,255,51,0.08)}
    .breakdown-table th{
      padding:10px 12px;text-align:left;font-weight:700;letter-spacing:1.5px;font-size:10px;
      border-right:1px solid var(--crt-dim);border-bottom:1px solid var(--crt-green)
    }
    .breakdown-table td{
      padding:12px 12px;border-bottom:1px solid var(--crt-dim);border-right:1px solid var(--crt-dim);
      overflow-wrap:anywhere;word-break:break-word;
    }
    .breakdown-table tbody tr:hover{background:rgba(51,255,51,0.05)}

    .element-link{color:var(--crt-green);text-decoration:underline;cursor:pointer;font-weight:700}
    .element-link:hover{color:#fff;text-shadow:0 0 10px var(--crt-glow)}
    .type-badge{display:inline-block;padding:2px 6px;font-size:9px;letter-spacing:1px;font-weight:700;text-transform:uppercase;border:1px solid var(--crt-dim);opacity:0.9}

    .confidence-high{color:var(--crt-green);font-weight:700}
    .confidence-medium{color:var(--crt-dim);font-weight:700}
    .confidence-low{color:#ff3333;font-weight:700}

    /* Filters on transmission pages */
    .transmission-filters{
      display:flex;gap:12px;align-items:center;flex-wrap:wrap;
      margin:16px 0;padding:12px;border:1px solid var(--crt-dim);background:rgba(0,0,0,0.22);
    }
    .transmission-filters input,
    .transmission-filters select{
      flex:1;min-width:220px;
      background:rgba(0,0,0,0.35);
      border:1px solid var(--crt-green);
      color:var(--crt-green);
      padding:10px 12px;
      font-family:var(--mono);
      font-size:12px;
      outline:none;
    }
    .transmission-filters select{flex:0.65}

    /* Audio player */
    .audio-player{border:1px solid var(--crt-dim);padding:16px;margin:16px 0;background:rgba(0,0,0,0.26)}
    .audio-controls{display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
    .play-btn{
      width:40px;height:40px;border:2px solid var(--crt-green);
      background:transparent;color:var(--crt-green);cursor:pointer;
      font-family:var(--mono);font-size:16px;transition:all .08s
    }
    .play-btn:hover{background:var(--crt-green);color:var(--crt-bg)}
    .play-btn:disabled{opacity:0.35;cursor:not-allowed}
    .time-display{font-family:var(--mono);font-size:11px;color:var(--crt-green);letter-spacing:1px;min-width:110px}
    .timeline{flex:1;min-width:180px;height:4px;background:var(--crt-dim);position:relative;cursor:pointer}
    .timeline-progress{height:100%;background:var(--crt-green);width:0%}
    .timeline-handle{
      position:absolute;top:-4px;width:12px;height:12px;background:var(--crt-green);
      border:1px solid var(--crt-green);transform:translateX(-50%);cursor:pointer;
      box-shadow:0 0 5px var(--crt-glow)
    }
    .volume-control{display:flex;align-items:center;gap:10px}
    .volume-icon{font-family:var(--mono);font-size:11px;color:var(--crt-green);letter-spacing:1px;opacity:0.9}
    .volume-slider{width:90px;height:4px;background:var(--crt-dim);position:relative;cursor:pointer}
    .volume-level{height:100%;background:var(--crt-green);width:100%}
    .track-info{font-family:var(--mono);font-size:10px;color:var(--crt-dim);margin-top:8px;opacity:0.75}

    /* INFO page layout */
    .info-grid{
      display:grid;
      grid-template-columns: 1.35fr 0.95fr;
      gap:16px;
      align-items:start;
    }

    .chat-container{
      border:1px solid var(--crt-dim);
      height:520px;
      overflow:hidden;
      background:rgba(0,0,0,0.28);
      position:relative;
    }
    .chat-log{
      font-size:11px;
      line-height:2.2;
      position:absolute;
      width:calc(100% - 30px);
      left:15px;
      top:0;
    }
    .chat-msg{margin-bottom:15px}
    .chat-user{color:var(--crt-green);font-weight:700}
    .chat-bot{color:var(--crt-dim);font-weight:700}
    .chat-location{color:var(--crt-dim);font-size:10px;margin-left:6px}
    .chat-timestamp{color:var(--crt-dim);font-size:10px;margin-right:8px}

    .chat-input-area{
      margin-top:12px;
      border:1px solid var(--crt-dim);
      padding:14px;
      background:rgba(0,0,0,0.22);
      display:flex;
      gap:12px;
      align-items:center;
    }
    .chat-input-area input{
      flex:1;
      font-family:var(--mono);
      font-size:11px;
      padding:10px 12px;
      border:1px solid var(--crt-green);
      background:rgba(0,0,0,0.35);
      color:var(--crt-green);
      outline:none;
    }
    .chat-input-area button{min-width:110px}

    .newsletter-form{
      border:1px solid var(--crt-dim);
      border-left:4px solid var(--crt-green);
      padding:18px;
      background:rgba(0,0,0,0.22);
    }
    .newsletter-form h2{
      font-size:12px;text-transform:uppercase;margin-bottom:12px;
      border-bottom:1px solid var(--crt-green);padding-bottom:8px
    }
    .newsletter-form .subcopy{
      font-size:11px;
      opacity:0.78;
      margin-bottom:12px;
      line-height:1.7;
    }
    .newsletter-form input{
      width:100%;
      font-family:var(--mono);
      font-size:11px;
      padding:10px 12px;
      border:1px solid var(--crt-green);
      background:rgba(0,0,0,0.35);
      color:var(--crt-green);
      margin-bottom:10px;
      outline:none;
    }
    .newsletter-form button{width:100%}
    .newsletter-form .privacy{font-size:10px;margin-top:10px;opacity:0.62}
    .newsletter-form .message{margin-top:10px;padding:10px;border:1px solid var(--crt-green);font-size:11px;display:none}
    .newsletter-form .message.success{color:var(--crt-green)}
    .newsletter-form .message.error{color:#ff3333;border-color:#ff3333}

    /* Slideshow block */
    .slideshow-box{
      margin-top:16px;
      border:1px solid var(--crt-dim);
      background:rgba(0,0,0,0.22);
      padding:14px;
    }
    .slideshow-stage{
      position:relative;
      width:100%;
      aspect-ratio: 16 / 9;
      border:1px solid var(--crt-dim);
      overflow:hidden;
      background:#000;
    }
    .slideshow-stage img{
      position:absolute;inset:0;
      width:100%;height:100%;
      object-fit:cover;
      opacity:0;
      transition:opacity 1.2s ease;
      filter: grayscale(1) contrast(1.05) brightness(0.9) blur(0.2px);
      transform:scale(1.01);
    }
    .slideshow-stage img.active{opacity:1}
    .slideshow-stage::after{
      content:'';
      position:absolute;inset:0;
      background:repeating-linear-gradient(
        0deg,
        rgba(0,0,0,0.20) 0px,
        rgba(0,0,0,0.20) 1px,
        transparent 1px,
        transparent 2px
      );
      mix-blend-mode:overlay;
      opacity:0.55;
      pointer-events:none;
    }
    .slideshow-caption{
      position:absolute;
      left:10px;right:10px;bottom:10px;
      padding:8px 10px;
      border:1px solid var(--crt-dim);
      background:rgba(0,0,0,0.55);
      color:var(--crt-green);
      font-size:10px;
      letter-spacing:1px;
      opacity:0.9;
      filter: blur(0.15px);
    }

    footer{
      margin-top:54px;
      padding-top:18px;
      border-top:1px solid var(--crt-dim);
      font-size:9px;
      color:var(--crt-dim);
      text-align:center;
      opacity:0.62;
      line-height:1.8;
    }

    @keyframes blink{0%,49%{opacity:1}50%,100%{opacity:0}}

    /* Mobile: no sideways scroll, tables become blocks */
    @media (max-width: 900px){
      nav a{min-width:auto;flex:1}
      .info-grid{grid-template-columns:1fr}
    }

    @media (max-width: 640px){
      .container{padding:20px 12px}
      .logo{font-size:24px}
      .logo .cursor{font-size:16px;top:-3px}

      nav{gap:8px}
      nav a{padding:12px 10px;font-size:9px}

      .breakdown-table thead{display:none}
      .breakdown-table, .breakdown-table tbody, .breakdown-table tr{display:block;width:100%}
      .breakdown-table tr{
        border:1px solid var(--crt-dim);
        margin:12px 0;
        padding:10px;
        background:rgba(0,0,0,0.20);
      }
      .breakdown-table td{
        display:flex;
        gap:10px;
        width:100%;
        padding:6px 0;
        border:0;
        align-items:flex-start;
      }
      .breakdown-table td:nth-child(1)::before{content:"TIME"; min-width:70px; color:var(--crt-dim); letter-spacing:1px;}
      .breakdown-table td:nth-child(2)::before{content:"TYPE"; min-width:70px; color:var(--crt-dim); letter-spacing:1px;}
      .breakdown-table td:nth-child(3)::before{content:"TITLE"; min-width:70px; color:var(--crt-dim); letter-spacing:1px;}
      .breakdown-table td:nth-child(4)::before{content:"CREDIT"; min-width:70px; color:var(--crt-dim); letter-spacing:1px;}
      .breakdown-table td:nth-child(5)::before{content:"CONF"; min-width:70px; color:var(--crt-dim); letter-spacing:1px;}
    }

    /* Session overlay (login) */
    #session-overlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,0.90);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10000;
      padding:20px;
    }
    #session-overlay.active{display:flex}

    .session-window{
      width:min(540px,100%);
      border:1px solid var(--crt-dim);
      background:rgba(0,0,0,0.55);
      box-shadow:0 0 40px rgba(0,255,80,0.12);
      padding:22px;
      position:relative;
    }

    .session-window::before{
      content:'';
      position:absolute;inset:0;
      background:repeating-linear-gradient(
        0deg,
        rgba(0,0,0,0.14) 0px,
        rgba(0,0,0,0.14) 1px,
        transparent 1px,
        transparent 2px
      );
      opacity:0.65;
      pointer-events:none;
    }

    .session-title{
      position:relative;
      text-align:center;
      font-size:12px;
      letter-spacing:3px;
      text-transform:uppercase;
      margin-bottom:10px;
      opacity:0.95;
    }
    .session-meta{
      position:relative;
      text-align:center;
      font-size:10px;
      color:var(--crt-dim);
      letter-spacing:2px;
      margin-bottom:16px;
      filter: blur(0.35px);
    }

    .session-row{
      position:relative;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
    }

    .session-row label{
      font-size:10px;
      color:var(--crt-dim);
      letter-spacing:2px;
      text-transform:uppercase;
      filter: blur(0.25px);
    }

    .session-input{
      width:min(420px,100%);
      border:1px solid var(--crt-green);
      background:rgba(0,0,0,0.40);
      color:var(--crt-green);
      padding:12px 12px;
      font-family:var(--mono);
      font-size:12px;
      outline:none;
      text-transform:uppercase;
      letter-spacing:2px;
      text-align:center;
    }

    .session-actions{
      position:relative;
      display:flex;
      justify-content:center;
      margin-top:16px;
    }

    .session-note{
      position:relative;
      margin-top:14px;
      text-align:center;
      font-size:10px;
      color:var(--crt-dim);
      opacity:0.78;
      line-height:1.6;
      filter: blur(0.25px);
    }
  </style>
</head>

<body>

  <!-- Session gate (centered, no explicit anonymous option) -->
  <div id="session-overlay" aria-hidden="true">
    <div class="session-window">
      <div class="session-title">WLSN SIGNAL ARCHIVE TERMINAL</div>
      <div class="session-meta">SESSION ID: <span id="session-id"></span></div>

      <div class="session-row">
        <label for="alias-input">ENTER CALLSIGN</label>
        <input id="alias-input" class="session-input" maxlength="18" autocomplete="off" spellcheck="false" placeholder="TYPE HERE">
      </div>

      <div class="session-actions">
        <button id="enter-btn" class="btn" type="button">ENTER ARCHIVE</button>
      </div>

      <div class="session-note">
        Local to this visit. No accounts. No tracking. Nothing persists beyond this session.
      </div>
    </div>
  </div>

  <div class="container">
    <header>
      <div class="logo">WLSN<span class="cursor">█</span></div>
      <div class="tagline">Western Light and Sound Network</div>
      <div class="tagline tagline-sub">Signal Archive</div>

      <div id="session-indicator" class="session-panel"></div>

      <nav>
        <a href="#transmissions" id="nav-transmissions">Broadcast Archive</a>
        <a href="#info" id="nav-info">Info</a>
      </nav>
    </header>

    <main id="app"></main>

    <footer>
      WLSN ARCHIVE SYSTEM | EST. 1967 | DECLASSIFIED 2025<br>
      Produced by Brain Crampsmen for WLSN under the ONE Signal distribution mark.
    </footer>
  </div>

  <script>
    /* Data (unchanged content, just routed differently) */
    const D = {
      transmissions: [
        {
          id:"001",
          title:"Initial Signal Test",
          date:"1967-08-12",
          dateFormatted:"12 AUG 1967",
          audioUrl:"audio/WLSN - Color Radio from Space - TRANSMISSION 001 - -Initial Signal Test - RECORDED- 12 AUG 1967_2_01.mp3",
          description:"First recorded transmission. Test pattern followed by musical fragments.",
          notes:"Recovered from magnetic tape, reel 001-A. Signal degradation minimal.",
          elements:["e001","e002","e036","e003","e004"]
        },
        {
          id:"002",
          title:"Evening Broadcast",
          date:"1967-09-03",
          dateFormatted:"03 SEP 1967",
          audioUrl:"",
          description:"Regular programming. Mix of commercial recordings and field recordings.",
          notes:"Source uncertain. Possible aircheck from listening post.",
          elements:["e005","e037","e006","e007"]
        },
        {
          id:"003",
          title:"Late Night Transmission",
          date:"1968-03-15",
          dateFormatted:"15 MAR 1968",
          audioUrl:"",
          description:"Cut broadcast. Multiple sources spliced together.",
          notes:"Tape quality excellent. Signal bleed appears intermittently.",
          elements:["e035","e008","e009","e010","e011","e012","e038","e013","e014","e015","e016","e017","e018","e019","e020","e021","e022","e023","e024","e025","e026","e027","e039","e028","e029","e030","e031","e032","e033","e034"]
        }
      ],
      elements: [
        {id:"e001",transmission_id:"001",start_time:"00:00",end_time:"00:45",type:"jingle",title:"WLSN Station Identification",primary_credit:"Unknown Announcer",source:"WLSN Internal Recording",year:"1967",notes:"Male voice. Broadcast training evident.",confidence:"high"},
        {id:"e002",transmission_id:"001",start_time:"00:45",end_time:"04:12",type:"song",title:"Blue in Green",primary_credit:"Miles Davis",source:"Kind of Blue (Columbia, 1959)",year:"1959",notes:"Partial capture. Fades early.",confidence:"high"},
        {id:"e003",transmission_id:"001",start_time:"04:12",end_time:"04:30",type:"unknown",title:"Unidentified Voice Fragment",primary_credit:"Unknown",source:"Unknown",year:null,notes:"Female voice. Possible adjacent-channel crosstalk.",confidence:"low"},
        {id:"e004",transmission_id:"001",start_time:"04:30",end_time:"05:00",type:"technical",title:"1kHz Reference Tone",primary_credit:"WLSN Technical",source:"Calibration Reference",year:"1967",notes:"Frequency reference signal.",confidence:"high"},
        {id:"e036",transmission_id:"001",start_time:"02:18",end_time:"02:22",type:"unknown",title:"Carrier Wave Interference",primary_credit:"Unknown",source:"Unknown",year:null,notes:"Brief heterodyne whistle. Frequency bleed.",confidence:"low"},

        {id:"e005",transmission_id:"002",start_time:"00:00",end_time:"00:15",type:"technical",title:"Time Signal",primary_credit:"WLSN Technical",source:"Synchronization",year:"1967",notes:"Six pip sequence.",confidence:"high"},
        {id:"e006",transmission_id:"002",start_time:"00:15",end_time:"07:45",type:"song",title:"A Love Supreme, Pt 1",primary_credit:"John Coltrane",source:"A Love Supreme (Impulse!, 1965)",year:"1965",notes:"Complete Part 1. Excellent fidelity.",confidence:"high"},
        {id:"e007",transmission_id:"002",start_time:"07:45",end_time:"08:10",type:"commercial",title:"Soft Drink Advertisement",primary_credit:"Unknown",source:"Radio Campaign",year:"1967",notes:"Regional variant possible.",confidence:"medium"},
        {id:"e037",transmission_id:"002",start_time:"04:22",end_time:"04:31",type:"unknown",title:"Spanish Language Fragment",primary_credit:"Unknown",source:"Unknown",year:null,notes:"Likely border-station bleed.",confidence:"low"},

        {id:"e008",transmission_id:"003",start_time:"00:00",end_time:"00:15",type:"jingle",title:"Weather Tag",primary_credit:"Los Angeles Station",source:"Broadcast Capture",year:"1968",notes:"Station tag fragment.",confidence:"high"},
        {id:"e009",transmission_id:"003",start_time:"00:15",end_time:"00:45",type:"commercial",title:"Cereal Spot",primary_credit:"Unknown",source:"Broadcast Capture",year:"1968",notes:"Cut version possible.",confidence:"high"},
        {id:"e010",transmission_id:"003",start_time:"00:45",end_time:"03:30",type:"song",title:"Look Through My Window",primary_credit:"The Mamas & The Papas",source:"Deliver (Dunhill, 1967)",year:"1967",notes:"Album track.",confidence:"high"},
        {id:"e011",transmission_id:"003",start_time:"03:30",end_time:"06:15",type:"song",title:"The Dance at the Gym",primary_credit:"West Side Story Cast",source:"Soundtrack (Columbia, 1961)",year:"1961",notes:"Mambo/Blues segment.",confidence:"high"},
        {id:"e012",transmission_id:"003",start_time:"06:15",end_time:"08:30",type:"song",title:"Pray for Surf",primary_credit:"The Honeys",source:"Capitol (1963)",year:"1963",notes:"Studio production.",confidence:"high"},
        {id:"e013",transmission_id:"003",start_time:"08:30",end_time:"10:45",type:"song",title:"Easy as 1-2-3",primary_credit:"Jan & Dean",source:"Liberty (1966)",year:"1966",notes:"Rare album track.",confidence:"medium"},
        {id:"e014",transmission_id:"003",start_time:"10:45",end_time:"12:50",type:"song",title:"Run Run Run",primary_credit:"The Gestures",source:"Soma (1964)",year:"1964",notes:"Regional hit.",confidence:"high"},
        {id:"e015",transmission_id:"003",start_time:"12:50",end_time:"15:20",type:"song",title:"Underdog",primary_credit:"Sly & The Family Stone",source:"Epic (1967)",year:"1967",notes:"Deep cut.",confidence:"high"},
        {id:"e016",transmission_id:"003",start_time:"15:20",end_time:"18:00",type:"song",title:"Sarah Saturday",primary_credit:"Lazy Smoke",source:"Onyx (1968)",year:"1968",notes:"Rare pressing.",confidence:"medium"},
        {id:"e017",transmission_id:"003",start_time:"18:00",end_time:"20:30",type:"song",title:"Tomorrow",primary_credit:"Strawberry Alarm Clock",source:"Uni (1967)",year:"1967",notes:"Album track.",confidence:"high"},
        {id:"e018",transmission_id:"003",start_time:"20:30",end_time:"22:45",type:"song",title:"Mama Says",primary_credit:"The Beach Boys",source:"Friends (1968)",year:"1968",notes:"Album fragment.",confidence:"high"},
        {id:"e019",transmission_id:"003",start_time:"22:45",end_time:"25:00",type:"song",title:"Going Out of My Head",primary_credit:"The Zombies",source:"1968",year:"1968",notes:"Alternate cut possible.",confidence:"high"},
        {id:"e020",transmission_id:"003",start_time:"25:00",end_time:"27:15",type:"song",title:"Please No More Sad Songs",primary_credit:"The Idle Race",source:"1968",year:"1968",notes:"Pre-ELO credit.",confidence:"high"},
        {id:"e021",transmission_id:"003",start_time:"27:15",end_time:"30:00",type:"song",title:"Compared to What",primary_credit:"Les McCann",source:"1969",year:"1969",notes:"Live capture.",confidence:"high"},
        {id:"e022",transmission_id:"003",start_time:"30:00",end_time:"31:00",type:"song",title:"Lost in Space Theme",primary_credit:"TV Theme",source:"CBS (1965)",year:"1965",notes:"Opening title.",confidence:"high"},
        {id:"e023",transmission_id:"003",start_time:"31:00",end_time:"33:30",type:"song",title:"In My Lonely Room",primary_credit:"Martha Reeves & The Vandellas",source:"1965",year:"1965",notes:"Motown cut.",confidence:"high"},
        {id:"e024",transmission_id:"003",start_time:"33:30",end_time:"34:30",type:"spoken",title:"TV Clip",primary_credit:"Unknown",source:"Broadcast Fragment",year:"1964",notes:"Dialog excerpt.",confidence:"medium"},
        {id:"e025",transmission_id:"003",start_time:"34:30",end_time:"35:00",type:"sound",title:"Audience Cheering",primary_credit:"Unknown",source:"Concert Film",year:"1964",notes:"Crowd wash.",confidence:"high"},
        {id:"e026",transmission_id:"003",start_time:"35:00",end_time:"37:30",type:"song",title:"Live Performance Excerpt",primary_credit:"Unknown",source:"Concert Film",year:"1964",notes:"Short excerpt.",confidence:"high"},
        {id:"e027",transmission_id:"003",start_time:"37:30",end_time:"39:00",type:"song",title:"Unverified Demo",primary_credit:"Unknown",source:"Bootleg Circulation",year:"1967",notes:"Unconfirmed source.",confidence:"low"},
        {id:"e028",transmission_id:"003",start_time:"39:00",end_time:"41:15",type:"song",title:"2002 A Hit Song",primary_credit:"The Free Design",source:"1969",year:"1969",notes:"Baroque pop arrangement.",confidence:"high"},
        {id:"e029",transmission_id:"003",start_time:"41:15",end_time:"43:30",type:"song",title:"Double Yellow Line",primary_credit:"The Music Machine",source:"1967",year:"1967",notes:"Single cut.",confidence:"high"},
        {id:"e030",transmission_id:"003",start_time:"43:30",end_time:"45:45",type:"song",title:"She Loves You",primary_credit:"The Beatles",source:"1963",year:"1963",notes:"Single.",confidence:"high"},
        {id:"e031",transmission_id:"003",start_time:"45:45",end_time:"48:30",type:"song",title:"God Only Knows",primary_credit:"The Beach Boys",source:"1966",year:"1966",notes:"Album track.",confidence:"high"},
        {id:"e032",transmission_id:"003",start_time:"48:30",end_time:"49:30",type:"spoken",title:"Film Narration",primary_credit:"Unknown",source:"Film Fragment",year:"1953",notes:"Narration excerpt.",confidence:"medium"},
        {id:"e033",transmission_id:"003",start_time:"49:30",end_time:"50:30",type:"spoken",title:"Film Dialog",primary_credit:"Unknown",source:"Film Fragment",year:"1964",notes:"Dialog excerpt.",confidence:"medium"},
        {id:"e034",transmission_id:"003",start_time:"50:30",end_time:"54:00",type:"song",title:"Solo Piano Performance",primary_credit:"Unknown",source:"TV Special",year:"1967",notes:"Short performance.",confidence:"high"},
        {id:"e035",transmission_id:"003",start_time:"00:08",end_time:"00:23",type:"jingle",title:"Radio Sting",primary_credit:"Station Singers",source:"Station Kit",year:"1967",notes:"Identification sting.",confidence:"high"},
        {id:"e038",transmission_id:"003",start_time:"12:08",end_time:"12:15",type:"unknown",title:"Morse Pattern",primary_credit:"Unknown",source:"Unknown",year:null,notes:"Rhythmic beeping. Interference.",confidence:"low"},
        {id:"e039",transmission_id:"003",start_time:"28:45",end_time:"28:52",type:"unknown",title:"Distorted Music Fragment",primary_credit:"Unknown",source:"Unknown",year:null,notes:"Heavily degraded. Unconfirmed.",confidence:"low"}
      ]
    };

    class App {
      constructor(){
        this.data = D;
        this.chatMessages = [];
        this.chatScrollPos = 0;
        this._sessionTimer = null;

        this.chatBots = [
          {name:'djmoondust',location:'Portland, OR'},
          {name:'tape_hound',location:'London, UK'},
          {name:'freq_drift',location:'Tokyo, JP'},
          {name:'vinyl_archive',location:'Melbourne, AU'},
          {name:'signal_lost',location:'Brooklyn, NY'},
          {name:'reel_to_reel',location:'Berlin, DE'}
        ];

        /* Keep modern slang out */
        this.botMessages = [
          {bot:1,text:"001: anyone else catch the dip right after the ident? feels like the deck grabbed.",reply:true},
          {bot:3,text:"003 opens with a clean weather tag, but the noise floor feels off for an aircheck."},
          {bot:0,text:"The WLSN ident shows up more than once, but never the same length twice."},
          {bot:4,text:"02:18 in 001: that whistle again. quiet, same band.",reply:true},
          {bot:2,text:"I tried matching the cereal spot in 003. close, not exact. maybe a different cut?"},
          {bot:5,text:"Hard splice at 03:22 on 002, then it returns brighter. two passes?",reply:true},
          {bot:1,text:"If it was rebroadcast, why keep the bleed? feels like the bleed is the point."},
          {bot:3,text:"Tape box handwriting switches formats mid-run. month/day once, then day.month."},
          {bot:0,text:"The ident consonants smear like it was played off a speaker into a mic.",reply:true},
          {bot:4,text:"Some tracks run a hair fast. could be speed drift, could be source.",reply:true},
          {bot:2,text:"Anyone recognize the four note chime? feels like a station kit."},
          {bot:5,text:"I keep hearing room tone under the music. like another space underneath.",reply:true},
          {bot:1,text:"003: the word 'network' pops once, then disappears. too clean to be accidental."},
          {bot:3,text:"That word sits on top of the hiss, not inside it."},
          {bot:0,text:"Reminder: tag artifacts separately from tracks. this is not a playlist.",reply:true},
          {bot:4,text:"Recurring artifacts feel more intentional than the tracks themselves."},
          {bot:2,text:"New guess: transmitter testing a collage rig.",reply:true},
          {bot:5,text:"Whatever it is, the edits are confident. whoever did this knew radio."}
        ];

        this.visitorResponses = [
          "timestamp?",
          "good ear",
          "not convinced",
          "that feels like deck noise",
          "any source for that?",
          "clip it and post timecode",
          "could be adjacent-channel bleed",
          "same artifact shows up in 003",
          "i hear it now",
          "wild if true",
          "might be speed drift",
          "that jingle is familiar",
          "post your notes",
          "does anyone have the reel box scan?",
          "why is that so clean",
          "this is getting weird",
          "new theory: private transmitter",
          "headphones recommended",
          "catalog it as an artifact",
          "save that for the next pass"
        ];

        this.init();
      }

      init(){
        this.initSessionGate();
        window.addEventListener('hashchange',()=>this.route());
        this.route();
        this.initChat();
      }

      /* Default landing: transmissions */
      route(){
        const raw = (window.location.hash || '#transmissions').slice(1);
        const parts = raw.split('/');
        const page = parts[0] || 'transmissions';
        const id = parts[1];

        this.render(page, id);

        // nav active
        const navLinks = document.querySelectorAll('nav a');
        navLinks.forEach(a=>{
          const href = (a.getAttribute('href')||'').replace('#','');
          a.classList.toggle('active', href === page);
        });

        this.updateSessionIndicator();
      }

      initSessionGate(){
        const existingUser = sessionStorage.getItem('wlsn_user');
        const existingSession = sessionStorage.getItem('wlsn_session');
        const existingStart = sessionStorage.getItem('wlsn_start');

        if(existingUser && existingSession && existingStart){
          this.updateSessionIndicator();
          return;
        }

        const overlay = document.getElementById('session-overlay');
        const idEl = document.getElementById('session-id');
        const nameEl = document.getElementById('alias-input');
        const enterBtn = document.getElementById('enter-btn');

        if(!overlay || !idEl || !nameEl || !enterBtn) return;

        const genId = ()=>{
          const a = Math.random().toString(36).slice(2,8).toUpperCase();
          const b = Math.random().toString(36).slice(2,6).toUpperCase();
          return (a+b).slice(0,10);
        };

        const genCallsign = ()=>{
          // alphanumeric, not WLSN
          const s = Math.random().toString(36).slice(2,10).toUpperCase();
          return ("USER_"+s.slice(0,6)).replace(/[^A-Z0-9_]/g,'');
        };

        const sessionId = genId();
        idEl.textContent = sessionId;

        const activate = ()=>{
          overlay.classList.add('active');
          overlay.setAttribute('aria-hidden','false');
          document.documentElement.style.overflow='hidden';
          setTimeout(()=>nameEl.focus(),60);
        };

        const commit = ()=>{
          let safe = (nameEl.value||'').trim().replace(/[^a-zA-Z0-9 _-]/g,'').slice(0,18);
          safe = safe.toUpperCase();
          if(!safe) safe = genCallsign();

          sessionStorage.setItem('wlsn_user', safe);
          sessionStorage.setItem('wlsn_session', sessionId);
          sessionStorage.setItem('wlsn_start', String(Date.now()));

          overlay.classList.remove('active');
          overlay.setAttribute('aria-hidden','true');
          document.documentElement.style.overflow='';
          this.updateSessionIndicator();
        };

        // force caps as they type
        nameEl.addEventListener('input', ()=>{
          nameEl.value = (nameEl.value || '').toUpperCase();
        });

        enterBtn.onclick = commit;
        nameEl.addEventListener('keydown', (e)=>{
          if(e.key === 'Enter'){ commit(); }
        });

        activate();
      }

      updateSessionIndicator(){
        const el = document.getElementById('session-indicator');
        if(!el) return;

        const user = sessionStorage.getItem('wlsn_user') || 'USER';
        const session = sessionStorage.getItem('wlsn_session') || '';
        const start = parseInt(sessionStorage.getItem('wlsn_start') || '0', 10);

        const fmt = (ms)=>{
          const s = Math.max(0, parseInt(ms/1000,10));
          const h = parseInt(s/3600,10);
          const m = parseInt((s%3600)/60,10);
          const ss = parseInt(s%60,10);
          const pad = (n)=>String(n).padStart(2,'0');
          return `${pad(h)}:${pad(m)}:${pad(ss)}`;
        };

        const render = ()=>{
          const now = Date.now();
          const runtime = start ? fmt(now-start) : '00:00:00';
          el.innerHTML = `LOGGED AS <b>${user}</b>  |  SESSION <b>${session}</b>  |  UPTIME <b>${runtime}</b>`;
        };

        render();
        if(this._sessionTimer) clearInterval(this._sessionTimer);
        this._sessionTimer = setInterval(render, 1000);
      }

      initChat(){
        this.shuffleArray(this.botMessages);
        for(let i=0;i<14;i++){
          const msg = this.botMessages[i % this.botMessages.length];
          const bot = this.chatBots[msg.bot];
          const now = new Date();
          const time = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
          this.chatMessages.push({user:bot.name,location:bot.location,text:msg.text,time,isBot:true});
        }
      }

      shuffleArray(arr){
        for(let i=arr.length-1;i>0;i--){
          const j=Math.floor(Math.random()*(i+1));
          [arr[i],arr[j]]=[arr[j],arr[i]];
        }
      }

      startChatScroll(){
        if(this.chatInterval) clearInterval(this.chatInterval);
        this.chatInterval=setInterval(()=>{
          if(window.location.hash.includes('info')){
            const container = document.querySelector('.chat-log');
            if(container){
              const lineHeight = parseFloat(getComputedStyle(container).lineHeight);
              this.chatScrollPos -= lineHeight;
              container.style.transform = `translateY(${this.chatScrollPos}px)`;

              if(Math.abs(this.chatScrollPos) > container.offsetHeight){
                const msgIdx = this.chatMessages.length % this.botMessages.length;
                const msg = this.botMessages[msgIdx];
                const bot = this.chatBots[msg.bot];
                const now = new Date();
                const time = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                this.chatMessages.push({user:bot.name,location:bot.location,text:msg.text,time,isBot:true});
                this.renderChat();
                this.chatScrollPos = 0;
              }
            }
          }
        }, 10000);
      }

      render(page, id){
        const app = document.getElementById('app');
        if(!app) return;

        if(page === 'transmissions'){
          app.innerHTML = this.rTransmissions();
          this.attachLinks();
        } else if(page === 'transmission'){
          app.innerHTML = this.rTransmission(id);
          this.attachLinks();
          this.initAudioPlayer();
          this.initTransmissionFilters(id);
        } else if(page === 'element'){
          app.innerHTML = this.rElement(id);
          this.attachLinks();
        } else if(page === 'info'){
          app.innerHTML = this.rInfo();
          this.renderChat();
          this.startChatScroll();
          this.attachChatInput();
          this.attachNewsletter();
          this.initSlideshow();
        } else {
          window.location.hash = '#transmissions';
        }
      }

      rTransmissions(){
        return `
          <div class="feature">
            <div class="feature-title">Broadcast Archive</div>
            <p>Recovered transmissions. Digitized from degraded analog sources.</p>
          </div>

          <div class="grid">
            ${this.data.transmissions.map(t=>`
              <div class="card" data-link="transmission/${t.id}">
                <div class="card-id">TRANSMISSION ${t.id}</div>
                <div class="card-title">${t.title}</div>
                <div class="card-date">${t.dateFormatted}</div>
                <div class="card-desc">${t.description}</div>
              </div>
            `).join('')}
          </div>
        `;
      }

      rTransmission(id){
        const t = this.data.transmissions.find(x=>x.id===id);
        if(!t) return `<p>Not found.</p>`;

        const els = this.data.elements.filter(e=>t.elements.includes(e.id));
        return `
          <a href="#transmissions" class="back-link">Back to Broadcast Archive</a>

          <div class="transmission-header">
            <div class="transmission-id">TRANSMISSION ${t.id}</div>
            <h1 class="transmission-title">${t.title}</h1>
            <div class="transmission-date">RECORDED: ${t.dateFormatted}</div>
            <div class="badge received">RECEIVED</div>
            <div style="margin-top:12px;opacity:0.82;line-height:1.7">${t.description}</div>
          </div>

          <div class="audio-player">
            <div class="audio-controls">
              <button class="play-btn" id="play-btn" ${t.audioUrl ? '' : 'disabled'}>${t.audioUrl ? '▶' : '|'}</button>
              <div class="time-display" id="time-display">${t.audioUrl ? '00:00 / 00:00' : 'NO AUDIO / 00:00'}</div>

              <div class="timeline" id="timeline" style="${t.audioUrl ? '' : 'opacity:0.35; pointer-events:none;'}">
                <div class="timeline-progress" id="timeline-progress"></div>
                <div class="timeline-handle" id="timeline-handle"></div>
              </div>

              <div class="volume-control" style="${t.audioUrl ? '' : 'opacity:0.35; pointer-events:none;'}">
                <span class="volume-icon">VOL</span>
                <div class="volume-slider" id="volume-slider">
                  <div class="volume-level" id="volume-level"></div>
                </div>
              </div>
            </div>

            <div class="track-info">TRANSMISSION ${t.id} // ${t.dateFormatted} // SOURCE: REEL-TO-REEL ${t.audioUrl ? '' : '// FILE PENDING'}</div>
            <audio id="audio-element" ${t.audioUrl ? `src="${t.audioUrl}"` : ''} preload="metadata"></audio>
          </div>

          <div class="transmission-filters">
            <input id="trans-filter-search" type="text" placeholder="Filter elements...">
            <select id="trans-filter-type"></select>
          </div>

          <table class="breakdown-table">
            <thead>
              <tr>
                <th>TIME</th><th>TYPE</th><th>TITLE</th><th>CREDIT</th><th>CONF.</th>
              </tr>
            </thead>
            <tbody>
              ${els.map(e=>`
                <tr class="el-row" data-type="${e.type}">
                  <td>${e.start_time}${e.end_time?'-'+e.end_time:''}</td>
                  <td><span class="type-badge">${e.type}</span></td>
                  <td><a href="#element/${e.id}" class="element-link">${e.title}</a></td>
                  <td>${e.primary_credit||'-'}</td>
                  <td class="confidence-${e.confidence}">${String(e.confidence).toUpperCase()}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>

          <div class="section">
            <div class="section-title">Archival Notes</div>
            <p style="opacity:0.82;line-height:1.8">${t.notes}</p>
          </div>
        `;
      }

      rElement(id){
        const e = this.data.elements.find(x=>x.id===id);
        if(!e) return `<p>Not found.</p>`;
        const t = this.data.transmissions.find(x=>x.id===e.transmission_id);

        return `
          <a href="#transmissions" class="back-link">Back to Broadcast Archive</a>

          <div class="transmission-header">
            <div class="transmission-id">ELEMENT DOSSIER // ${e.id.toUpperCase()} // ${e.type.toUpperCase()}</div>
            <h1 class="transmission-title">${e.title}</h1>
            <div class="transmission-date">IN: TRANSMISSION ${t ? t.id : '?'} // ${t ? t.title : ''}</div>
            <div class="badge archived">ARCHIVED</div>
          </div>

          <div class="section">
            <div class="section-title">Metadata</div>
            <p><span style="color:var(--crt-dim)">TIME:</span> <b style="color:var(--crt-green)">${e.start_time}${e.end_time?' - '+e.end_time:''}</b></p>
            <p><span style="color:var(--crt-dim)">CREDIT:</span> <b style="color:var(--crt-green)">${e.primary_credit || 'Unknown'}</b></p>
            <p><span style="color:var(--crt-dim)">SOURCE:</span> <b style="color:var(--crt-green)">${e.source || 'Unknown'}</b></p>
            <p><span style="color:var(--crt-dim)">YEAR:</span> <b style="color:var(--crt-green)">${e.year || 'Unknown'}</b></p>
            <p><span style="color:var(--crt-dim)">CONFIDENCE:</span> <span class="confidence-${e.confidence}">${String(e.confidence).toUpperCase()}</span></p>
          </div>

          ${e.notes ? `
          <div class="section">
            <div class="section-title">Notes</div>
            <p style="opacity:0.82;line-height:1.8">${e.notes}</p>
          </div>` : ``}
        `;
      }

      rInfo(){
        return `
          <div class="intro">
            <h1>Info</h1>
            <p>Recovered broadcasts logged as transmissions. Identifiable tracks and fragments are cataloged as elements. Some sources remain unconfirmed.</p>
            <p style="margin-bottom:0">Leave notes if you catch a mismatch, an alternate cut, a splice point, or a recurring artifact.</p>
          </div>

          <div class="info-grid">
            <div>
              <div class="section">
                <div class="section-title">Discussion Terminal</div>
                <div class="chat-container">
                  <div class="chat-log" id="chat-log"></div>
                </div>

                <div class="chat-input-area">
                  <input type="text" id="chat-input" placeholder="Enter message..." maxlength="200">
                  <button id="chat-send" class="btn" type="button">Send</button>
                </div>
              </div>
            </div>

            <div>
              <div class="newsletter-form">
                <h2>Archive Updates</h2>
                <div class="subcopy">Be alerted when new signals are digitized and added to the archive.</div>
                <form id="newsletter-form" action="https://formspree.io/f/xeeeorzj" method="POST">
                  <input type="text" name="name" placeholder="Name" required>
                  <input type="email" name="email" placeholder="Email" required>
                  <button type="submit" class="btn">Subscribe</button>
                  <div class="privacy">Updates only. No spam. Unsubscribe anytime.</div>
                  <div class="message" id="form-message"></div>
                </form>
              </div>

              <div class="slideshow-box">
                <div class="section-title" style="margin-bottom:12px">Field Images</div>
                <div class="slideshow-stage" id="slideshow-stage" aria-label="Image slideshow">
                  <img id="slide-a" alt="">
                  <img id="slide-b" alt="">
                  <div class="slideshow-caption" id="slide-caption">LOADING...</div>
                </div>
                <div style="margin-top:10px;font-size:10px;color:var(--crt-dim);opacity:0.75;line-height:1.6">
                  Reads <b style="color:var(--crt-green)">slideshow/manifest.json</b>. Images live in <b style="color:var(--crt-green)">/slideshow/</b>.
                </div>
              </div>
            </div>
          </div>
        `;
      }

      renderChat(){
        const c = document.getElementById('chat-log');
        if(!c) return;

        c.innerHTML = this.chatMessages.map(m=>`
          <div class="chat-msg">
            <span class="chat-timestamp">[${m.time}]</span>
            <span class="${m.isBot ? 'chat-bot' : 'chat-user'}">${m.user}</span>
            <span class="chat-location">${m.location}</span>:
            ${m.text}
          </div>
        `).join('');
      }

      attachChatInput(){
        const input = document.getElementById('chat-input');
        const btn = document.getElementById('chat-send');

        const send = ()=>{
          const msg = (input.value||'').trim();
          if(!msg) return;

          const user = sessionStorage.getItem('wlsn_user') || 'USER';
          const now = new Date();
          const time = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

          this.chatMessages.push({user:user,location:'',text:msg,time,isBot:false});
          input.value='';
          this.renderChat();

          setTimeout(()=>{
            const randomBot = this.chatBots[Math.floor(Math.random()*this.chatBots.length)];
            const randomResponse = this.visitorResponses[Math.floor(Math.random()*this.visitorResponses.length)];
            const now2 = new Date();
            const time2 = `${String(now2.getHours()).padStart(2,'0')}:${String(now2.getMinutes()).padStart(2,'0')}`;
            this.chatMessages.push({user:randomBot.name,location:randomBot.location,text:randomResponse,time:time2,isBot:true});
            this.renderChat();
          }, Math.random()*7000 + 2500);
        };

        if(btn) btn.onclick = send;
        if(input) input.onkeypress = (e)=>{ if(e.key==='Enter'){ send(); } };
      }

      attachNewsletter(){
        const form = document.getElementById('newsletter-form');
        if(!form) return;

        form.onsubmit = async (e)=>{
          e.preventDefault();
          const msg = document.getElementById('form-message');
          if(!msg) return;

          try{
            const res = await fetch(form.action, {
              method:'POST',
              body:new FormData(form),
              headers:{'Accept':'application/json'}
            });

            if(res.ok){
              msg.textContent = 'Subscribed successfully!';
              msg.className = 'message success';
              msg.style.display = 'block';
              form.reset();
            } else {
              msg.textContent = 'Error. Please try again.';
              msg.className = 'message error';
              msg.style.display = 'block';
            }
          } catch(err){
            msg.textContent = 'Error. Please try again.';
            msg.className = 'message error';
            msg.style.display = 'block';
          }
        };
      }

      attachLinks(){
        document.querySelectorAll('[data-link]').forEach(el=>{
          el.onclick = ()=>{ window.location.hash = el.dataset.link; };
        });
      }

      initTransmissionFilters(id){
        const t = this.data.transmissions.find(x=>x.id===id);
        const els = t ? this.data.elements.filter(e=>t.elements.includes(e.id)) : [];

        const search = document.getElementById('trans-filter-search');
        const typeSel = document.getElementById('trans-filter-type');
        const table = document.querySelector('.breakdown-table');
        if(!search || !typeSel || !table) return;

        const types = new Set();
        els.forEach(e=>{ if(e && e.type) types.add(e.type); });

        typeSel.innerHTML = '';
        const allOpt = document.createElement('option');
        allOpt.value = 'all';
        allOpt.textContent = 'ALL TYPES';
        typeSel.appendChild(allOpt);

        Array.from(types).sort().forEach(t=>{
          const o=document.createElement('option');
          o.value=t;
          o.textContent=String(t).toUpperCase();
          typeSel.appendChild(o);
        });

        const rows = Array.from(table.querySelectorAll('tbody tr'));

        const apply = ()=>{
          const q = (search.value||'').trim().toLowerCase();
          const tval = (typeSel.value||'all').trim().toLowerCase();

          rows.forEach(r=>{
            const txt = r.textContent.toLowerCase();
            const rt = (r.getAttribute('data-type')||'').toLowerCase();
            const okQ = !q || txt.includes(q);
            const okT = (tval === 'all') || rt === tval;
            r.style.display = (okQ && okT) ? '' : 'none';
          });
        };

        search.addEventListener('input', apply);
        typeSel.addEventListener('change', apply);
        apply();
      }

      initAudioPlayer(){
        const audio = document.getElementById('audio-element');
        const playBtn = document.getElementById('play-btn');
        const timeDisplay = document.getElementById('time-display');
        const timeline = document.getElementById('timeline');
        const timelineProgress = document.getElementById('timeline-progress');
        const timelineHandle = document.getElementById('timeline-handle');
        const volumeSlider = document.getElementById('volume-slider');
        const volumeLevel = document.getElementById('volume-level');

        if(!audio || !playBtn || !timeDisplay || !timeline || !timelineProgress || !timelineHandle || !volumeSlider || !volumeLevel) return;

        const formatTime = (seconds)=>{
          const m = Math.floor(seconds/60);
          const s = Math.floor(seconds%60);
          return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        };

        playBtn.onclick = ()=>{
          if(audio.paused){
            audio.play();
            playBtn.textContent='❚❚';
          } else {
            audio.pause();
            playBtn.textContent='▶';
          }
        };

        audio.ontimeupdate = ()=>{
          if(!audio.duration || Number.isNaN(audio.duration)) return;
          const percent = (audio.currentTime/audio.duration)*100;
          timelineProgress.style.width = percent + '%';
          timelineHandle.style.left = percent + '%';
          timeDisplay.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;
        };

        audio.onloadedmetadata = ()=>{
          if(!audio.duration || Number.isNaN(audio.duration)) return;
          timeDisplay.textContent = `00:00 / ${formatTime(audio.duration)}`;
        };

        timeline.onclick = (e)=>{
          if(!audio.duration || Number.isNaN(audio.duration)) return;
          const rect = timeline.getBoundingClientRect();
          const percent = (e.clientX - rect.left) / rect.width;
          audio.currentTime = Math.max(0, Math.min(audio.duration, percent*audio.duration));
        };

        volumeSlider.onclick = (e)=>{
          const rect = volumeSlider.getBoundingClientRect();
          const percent = (e.clientX - rect.left) / rect.width;
          audio.volume = Math.max(0, Math.min(1, percent));
          volumeLevel.style.width = (audio.volume*100) + '%';
        };
      }

      /* Slideshow: reads slideshow/manifest.json */
      async initSlideshow(){
        const stage = document.getElementById('slideshow-stage');
        const a = document.getElementById('slide-a');
        const b = document.getElementById('slide-b');
        const cap = document.getElementById('slide-caption');
        if(!stage || !a || !b || !cap) return;

        const manifestUrl = 'slideshow/manifest.json';

        let files = [];
        try{
          const res = await fetch(manifestUrl, {cache:'no-store'});
          if(!res.ok) throw new Error('manifest fetch failed');
          files = await res.json();
          if(!Array.isArray(files)) throw new Error('manifest not array');
          files = files.filter(Boolean).map(String);
        } catch(err){
          cap.textContent = 'MANIFEST NOT FOUND';
          return;
        }

        if(!files.length){
          cap.textContent = 'NO IMAGES LISTED';
          return;
        }

        // Preload
        const toUrl = (name)=> 'slideshow/' + encodeURI(name);

        let idx = 0;
        let showA = true;

        const setCaption = (name)=>{
          const clean = name.replace(/\.[^/.]+$/, '');
          cap.textContent = clean.toUpperCase();
        };

        const show = (imgEl, name)=>{
          return new Promise((resolve)=>{
            imgEl.onload = ()=>resolve(true);
            imgEl.onerror = ()=>resolve(false);
            imgEl.src = toUrl(name);
            imgEl.alt = name;
          });
        };

        // First image
        const ok0 = await show(a, files[0]);
        a.classList.add('active');
        b.classList.remove('active');
        setCaption(files[0]);

        if(!ok0){
          cap.textContent = 'IMAGE LOAD ERROR';
        }

        const cycle = async ()=>{
          idx = (idx + 1) % files.length;
          const nextName = files[idx];

          const front = showA ? b : a;
          const back  = showA ? a : b;

          const ok = await show(front, nextName);
          if(!ok){
            cap.textContent = 'IMAGE LOAD ERROR';
            return;
          }

          back.classList.remove('active');
          front.classList.add('active');
          setCaption(nextName);
          showA = !showA;
        };

        // Slow cycle
        if(this._slideshowTimer) clearInterval(this._slideshowTimer);
        this._slideshowTimer = setInterval(cycle, 9000);
      }
    }

    new App();
  </script>
</body>
</html>
